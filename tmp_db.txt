                'price': price_id,
                'quantity': 1,
            }],
            'mode': 'subscription',
            'success_url': f'https://{domain}/success?session_id={{CHECKOUT_SESSION_ID}}',
            'cancel_url': f'https://{domain}/cancel',
            'metadata': metadata,
            'subscription_data': {
                'metadata': metadata,
            },
        }
        
        import logging
        logger = logging.getLogger('gunicorn.error')
        
        if apply_trial_coupon:
            coupon_id = os.getenv('STRIPE_COUPON_FIRST_MONTH', 'sfaexZAF')
            try:
                coupon = stripe.Coupon.retrieve(coupon_id)
                if coupon.valid:
                    session_params['discounts'] = [{'coupon': coupon_id}]
                    metadata['trial_applied'] = 'true'
                    logger.info(f"[STRIPE] Coupon {coupon_id} validated and applied")
                else:
                    logger.warning(f"[STRIPE] Coupon {coupon_id} is no longer valid, skipping")
            except StripeError as ce:
                logger.warning(f"[STRIPE] Coupon {coupon_id} retrieval failed: {ce}, skipping coupon")
        
        logger.info(f"[STRIPE] Creating checkout session for guild {guild_id}, product {product_type}, trial={apply_trial_coupon}")
        logger.info(f"[STRIPE] Session params keys: {list(session_params.keys())}")
        logger.info(f"[STRIPE] API key set: {bool(stripe.api_key)}, key prefix: {stripe.api_key[:8] if stripe.api_key else 'NONE'}...")
        
        stripe.max_network_retries = 1
        checkout_session = stripe.checkout.Session.create(**session_params)  # type: ignore[arg-type]
        logger.info(f"[STRIPE] Checkout session created: {checkout_session.id}")
        
        return checkout_session.url or ""
        
    except StripeError as e:
        import logging
        logging.getLogger('gunicorn.error').error(f"[STRIPE] Stripe API error: {e}")
        raise ValueError(f"Stripe error: {str(e)}")
    except Exception as e:
        import logging
        logging.getLogger('gunicorn.error').error(f"[STRIPE] Checkout creation failed: {e}")
        raise ValueError(f"Checkout creation failed: {str(e)}")


_db_pool_initialized = False

def init_db_pool():
    """Initialize PostgreSQL connection pool"""
    global db_pool, _db_pool_initialized
    if _db_pool_initialized and db_pool is not None:
        return
    if not DATABASE_URL:
        raise ValueError("DATABASE_URL environment variable is not set")
    db_pool = psycopg2.pool.ThreadedConnectionPool(
        minconn=1,
        maxconn=10,
        dsn=DATABASE_URL
    )
    _db_pool_initialized = True
    print("âœ… PostgreSQL connection pool initialized")
    
    # Run migrations on startup (guarded internally)
    run_migrations()

class ConnectionWrapper:
    """Wrapper to make psycopg2 connection behave like sqlite3 connection"""
    def __init__(self, conn):
        self._conn = conn
        self._cursor = None
    
    def execute(self, query, params=None):
        """Execute a query and return a cursor (mimics sqlite3 behavior)"""
        self._cursor = self._conn.cursor(cursor_factory=RealDictCursor)
        if params:
            self._cursor.execute(query, params)
        else:
            self._cursor.execute(query)
