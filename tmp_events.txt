
@bot.event
async def on_guild_join(guild):
    """Send welcome message with setup instructions when bot joins a new server"""
    now = datetime.now(timezone.utc)
    last_join = _recent_guild_joins.get(guild.id)
    if last_join and (now - last_join).total_seconds() < 60:
        print(f"âš ï¸ Duplicate on_guild_join for {guild.name} (ID: {guild.id}) â€” skipping")
        return
    _recent_guild_joins[guild.id] = now
    
    print(f"ðŸŽ‰ Bot joined new server: {guild.name} (ID: {guild.id})")
    
    inviter = guild.owner
    
    embed = create_setup_embed()
    
    try:
        if inviter:
            await inviter.send(embed=embed)
            print(f"âœ… Sent welcome DM to {inviter} in {guild.name}")
        else:
            print(f"âš ï¸ Could not find owner for {guild.name}")
    except discord.Forbidden:
        print(f"âŒ Could not DM owner of {guild.name} - DMs disabled")
    except Exception as e:
        print(f"âŒ Error sending welcome DM for {guild.name}: {e}")
    
    try:
        target_channel = guild.system_channel
        if not target_channel:
            for channel in guild.text_channels:
                if channel.permissions_for(guild.me).send_messages:
                    target_channel = channel
                    break
        
        if target_channel:
            view = SetupInstructionsView()
            
            welcome_text = f"ðŸ‘‹ Welcome! I'm **On the Clock**, your professional Discord timeclock bot.\n\n"
            if inviter:
                welcome_text += f"{inviter.mention} added me to help manage your team's time tracking.\n\n"
            welcome_text += "Click the button below for setup instructions and getting started guide!"
            
            await target_channel.send(welcome_text, view=view)
            print(f"âœ… Sent welcome button to #{target_channel.name} in {guild.name}")
        else:
            print(f"âš ï¸ Could not find any text channel to send welcome button in {guild.name}")
    except Exception as e:
        print(f"âŒ Error sending welcome button to channel in {guild.name}: {e}")
    
    # Add guild to bot_guilds table
    try:
        with db() as conn:
            conn.execute("""
                INSERT INTO bot_guilds (guild_id, guild_name, joined_at, is_present, left_at)
                VALUES (%s, %s, NOW(), TRUE, NULL)
                ON CONFLICT (guild_id) DO UPDATE 
                SET guild_name = EXCLUDED.guild_name, joined_at = NOW(), is_present = TRUE, left_at = NULL
            """, (str(guild.id), guild.name))
        print(f"âœ… Added {guild.name} to bot_guilds table")
    except Exception as e:
        print(f"âŒ Error adding guild to bot_guilds table: {e}")

    # Set trial start date
    try:
        with db() as conn:
            conn.execute("""
                INSERT INTO guild_settings (guild_id, trial_start_date)
                VALUES (%s, NOW())
                ON CONFLICT (guild_id) DO NOTHING
            """, (guild.id,))
        print(f"âœ… Set trial start date for {guild.name}")
    except Exception as e:
        print(f"âŒ Error setting trial start date for {guild.name}: {e}")


@bot.event
async def on_member_join(member):
    """Handle new members joining - special handling for demo server"""
    if member.guild.id != DEMO_SERVER_ID:
        # Check if they are a registered employee in a non-demo server
        try:
            with db() as conn:
                cursor = conn.execute(
                    "SELECT 1 FROM employee_profiles WHERE guild_id = %s AND user_id = %s",
                    (member.guild.id, member.id)
                )
                is_employee = cursor.fetchone()
                
                if is_employee:
                    # They are a returning employee, re-apply the role if configured
                    cursor = conn.execute(
                        "SELECT employee_role_id FROM guild_settings WHERE guild_id = %s",
                        (member.guild.id,)
                    )
                    row = cursor.fetchone()
                    if row and row['employee_role_id']:
                        role = member.guild.get_role(int(row['employee_role_id']))
                        if role:
                            await member.add_roles(role, reason="Auto-assigned for returning employee")
                            print(f"âœ… Re-assigned employee role to {member.display_name} in {member.guild.name}")
        except Exception as e:
            print(f"âŒ Error checking/assigning role for returning member {member.id} in {member.guild.id}: {e}")
        return
    
    print(f"ðŸ‘‹ New member joined demo server: {member.display_name}")
    
    try:
        # Use production URL for OAuth compatibility
        dashboard_url = "https://time-warden.com"
        
        embed = discord.Embed(
            title="ðŸŽ® Welcome to the Time Warden Demo Server!",
            description="Thanks for checking out our Discord timeclock bot! This demo lets you explore **all features** with live test data.",
            color=0x00FFFF  # Cyan to match branding
        )
        embed.add_field(
            name="ðŸŽ­ STEP 1: Choose Your Demo Persona",
            value="Click a button below to begin your demo:\nâ€¢ ðŸ‘· **Become Employee** - Test clock in/out features\nâ€¢ ðŸ‘‘ **Become Admin** - Manage employees and settings",
            inline=False
        )
        embed.add_field(
            name="ðŸ–¥ï¸ STEP 2: Try the Web Dashboard",
            value=f"[Login to Dashboard]({dashboard_url}/auth/login)\n\nExplore our core product! The full admin dashboard allows you to manage staff, edit timesheets, view reports, and configure server settings.",
            inline=False
        )
        embed.add_field(
            name="ðŸ“± STEP 3: Try the Kiosk Mode (BETA)",
            value=f"[Open Demo Kiosk]({dashboard_url}/kiosk/{DEMO_SERVER_ID})\n\nOur upcoming physical workplace solution. Test our tablet-friendly interface with PIN-based clock in/out.",
            inline=False
        )
        embed.add_field(
            name="ðŸ’¬ Discord Commands",
            value="â€¢ `/clock` - Open your personal timeclock\nâ€¢ `/help` - See all available commands\nâ€¢ `/report` - Generate timesheet reports",
            inline=False
        )
        embed.set_footer(text="Time Warden - Professional Time Tracking for Discord Teams")
        
        # Send Welcome DM as a reference
        try:
            await member.send(embed=embed)
            print(f"âœ… Sent welcome DM to {member.display_name}")
        except discord.Forbidden:
            print(f"âš ï¸ Could not DM {member.display_name} - DMs disabled")
            
        # Send Interactive Onboarding directly in the server
        channel = member.guild.system_channel
        if not channel:
            # Fallback to the first available text channel we can send in
            for c in member.guild.text_channels:
                if c.permissions_for(member.guild.me).send_messages:
                    channel = c
                    break
                    
        if channel:
            view = DemoRoleSwitcherView()
            await channel.send(
                content=f"ðŸ‘‹ Welcome {member.mention}! Please select your demo experience below:",
                embed=embed,
                view=view
            )
            print(f"âœ… Sent interactive role selector to #{channel.name} for {member.display_name}")
            
    except Exception as e:
        print(f"âŒ Error sending welcome messages: {e}")


@bot.event
async def on_guild_remove(guild):
    """Handle bot being removed from a server - archive paid servers, delete non-paid server data"""
    print(f"ðŸ‘‹ Bot removed from server: {guild.name} (ID: {guild.id})")
    guild_id_str = str(guild.id)
    guild_id_int = guild.id
    
    try:
        with db() as conn:
            # Check if this server has paid access
            cursor = conn.execute(
                "SELECT bot_access_paid FROM server_subscriptions WHERE guild_id = %s",
                (guild_id_int,)
            )
            result = cursor.fetchone()
            has_paid_access = result and result.get('bot_access_paid', False)
            
            if has_paid_access:
                # PAID SERVER: Just mark as not present (archive) - keep all data for potential re-add
                conn.execute("""
                    UPDATE bot_guilds 
                    SET is_present = FALSE, left_at = NOW() 
                    WHERE guild_id = %s
                """, (guild_id_str,))
                print(f"ðŸ“ Archived paid server {guild.name} - subscription data preserved")
            else:
                # NON-PAID SERVER: Delete all server data
                print(f"ðŸ—‘ï¸ Cleaning up non-paid server {guild.name}...")
                
                # Delete employee profiles
                conn.execute("DELETE FROM employee_profiles WHERE guild_id = %s", (guild_id_int,))
                print(f"   - Deleted employee profiles")
                
                # Delete time adjustment requests
                conn.execute("DELETE FROM time_adjustment_requests WHERE guild_id = %s", (guild_id_int,))
                print(f"   - Deleted time adjustment requests")
                
                # Delete admin roles
                conn.execute("DELETE FROM admin_roles WHERE guild_id = %s", (guild_id_str,))
                print(f"   - Deleted admin roles")
                
                conn.execute("DELETE FROM employee_roles WHERE guild_id = %s", (guild_id_str,))
                print(f"   - Deleted employee roles")
                
                # Delete guild settings
                # conn.execute("DELETE FROM guild_settings WHERE guild_id = %s", (guild_id_int,))
                # print(f"   - Deleted guild settings")
                # Phase 2: We no longer delete guild_settings so trial_start_date is permanently preserved
                
                # Delete sessions
                conn.execute("DELETE FROM timeclock_sessions WHERE guild_id = %s", (guild_id_int,))
                print(f"   - Deleted sessions")
                
                # Delete server subscription record (if any non-paid entry exists)
                conn.execute("DELETE FROM server_subscriptions WHERE guild_id = %s AND (bot_access_paid = FALSE OR bot_access_paid IS NULL)", (guild_id_int,))
                
                # Delete from bot_guilds entirely
                conn.execute("DELETE FROM bot_guilds WHERE guild_id = %s", (guild_id_str,))
                print(f"âœ… Completely removed non-paid server {guild.name} and all data")
                
    except Exception as e:
        print(f"âŒ Error handling guild removal for {guild.name}: {e}")

