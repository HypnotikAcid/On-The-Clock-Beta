{% extends "dashboard_base.html" %}

{% block title %}{{ server.name }} - Overview{% endblock %}

{% block content %}
<div class="content-header" style="display: flex; justify-content: space-between; align-items: flex-end;">
    <div>
        <h1 class="content-title">Server Overview</h1>
        <p class="content-subtitle">{{ server.name }}</p>
    </div>
    <div class="hierarchy-badge"
        style="margin-bottom: 2rem; background: rgba(30,30,40,0.7); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
        <span
            style="font-size: 0.85rem; color: #8B949E; margin-right: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Hierarchy
            Level:</span>
        {% if is_bot_owner %}
        <span class="badge"
            style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; padding: 4px 10px; border-radius: 20px; font-weight: bold;">ü§ñ
            Bot Developer</span>
        {% elif user_role == 'owner' %}
        <span class="badge"
            style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; border: 1px solid #F59E0B; padding: 4px 10px; border-radius: 20px; font-weight: bold;">üëë
            Server Owner</span>
        {% elif user_role == 'admin' %}
        <span class="badge"
            style="background: rgba(16, 185, 129, 0.2); color: #10B981; border: 1px solid #10B981; padding: 4px 10px; border-radius: 20px; font-weight: bold;">üõ°Ô∏è
            Admin</span>
        {% else %}
        <span class="badge"
            style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; border: 1px solid #3B82F6; padding: 4px 10px; border-radius: 20px; font-weight: bold;">üë∑
            Employee</span>
        {% endif %}
    </div>
</div>

<div class="tiles-grid">
    <div class="tile" id="subscription-tile">
        <h2><span class="tile-icon">üíé</span>Subscription Status</h2>
        <div class="stat-row">
            <span class="stat-label">Tier:</span>
            <span class="stat-value" id="tier-status">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Dashboard Access:</span>
            <span class="stat-value" id="dashboard-access">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Data Retention:</span>
            <span class="stat-value" id="retention-days">Loading...</span>
        </div>
        <div class="stat-row" id="cancellation-warning-row" style="display: none;">
            <span class="stat-label">Status:</span>
            <span class="stat-value" id="cancellation-warning" style="color: #ef4444; font-weight: bold;">Canceling on
                period end</span>
        </div>
        <div id="subscription-actions" style="margin-top: 15px; display: none;">
            <!-- Buttons injected here by JS -->
        </div>
    </div>

    <div class="tile" id="kiosk-access-tile">
        <h2><span class="tile-icon">üñ•Ô∏è</span>Kiosk Access</h2>
        <p class="tile-description">Tablet-friendly clock-in station.</p>
        {% if server_settings.tier in ['pro', 'premium', 'grandfathered'] or is_demo_server %}
        <a href="/kiosk/{{ server.id }}" target="_blank" class="btn btn-primary"
            style="display: block; text-align: center; margin-top: 15px; text-decoration: none;">Launch Kiosk üöÄ</a>
        {% else %}
        <a href="/dashboard/purchase?guild_id={{ server.id }}" class="btn btn-secondary"
            style="display: block; text-align: center; margin-top: 15px; text-decoration: none; opacity: 0.7;"
            title="Requires Pro Tier">Launch Kiosk üîí</a>
        {% endif %}
    </div>

    <div class="tile" id="quick-stats-tile">
        <h2><span class="tile-icon">üìä</span>Quick Stats</h2>
        <div class="stat-row">
            <span class="stat-label">Active Employees:</span>
            <span class="stat-value" id="employee-count">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Currently Clocked In:</span>
            <span class="stat-value" id="clocked-in-count">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Pending Adjustments:</span>
            <span class="stat-value" id="pending-adjustments">{{ pending_adjustments }}</span>
        </div>
    </div>

    <div class="tile" id="system-health-tile"
        style="border: 1px solid {% if error_count > 0 %}rgba(239,68,68,0.3){% else %}rgba(16,185,129,0.2){% endif %};">
        <h2><span class="tile-icon">ü©∫</span>System Health</h2>
        <div class="stat-row">
            <span class="stat-label">Unresolved Errors:</span>
            <span class="stat-value"
                style="color: {% if error_count > 0 %}#ef4444{% else %}#10B981{% endif %}; font-weight: bold;">{{
                error_count }}</span>
        </div>
        {% if error_count > 0 %}
        <a href="#" class="tile-link" style="color: #ef4444; margin-top: 10px; display: inline-block;">Resolve Errors
            &rarr;</a>
        {% else %}
        <p class="tile-description" style="color: #10B981; font-size: 0.85rem; margin-top: 10px;">All systems
            operational.</p>
        {% endif %}
    </div>

    <div class="tile" id="data-pruning-tile">
        <h2><span class="tile-icon">üßπ</span>Auto-Pruning</h2>
        <div class="stat-row">
            <span class="stat-label">Shift Logs:</span>
            <span class="stat-value" id="prune-logs-status">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Generated Reports:</span>
            <span class="stat-value" id="prune-reports-status">Loading...</span>
        </div>
        <a href="/dashboard/server/{{ server.id }}/integrations" class="tile-link"
            style="margin-top: 10px; display: inline-block;">Configure Pruning &rarr;</a>
    </div>

    {% if user_role == 'admin' %}
    <div class="tile" id="admin-roles-tile">
        <h2><span class="tile-icon">üë•</span>Admin Roles</h2>
        <p class="tile-description">Manage who has admin access</p>
        <div id="admin-roles-preview">Loading...</div>
        <a href="/dashboard/server/{{ server.id }}/admin-roles" class="tile-link">Manage Admin Roles &rarr;</a>
    </div>

    <div class="tile" id="employee-roles-tile">
        <h2><span class="tile-icon">üë∑</span>Employee Roles</h2>
        <p class="tile-description">Manage employee role access</p>
        <div id="employee-roles-preview">Loading...</div>
        <a href="/dashboard/server/{{ server.id }}/employee-roles" class="tile-link">Manage Employee Roles &rarr;</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block page_scripts %}
<script>
    const guildId = '{{ server.id }}';
    const userRole = '{{ user_role }}';

    async function loadOverviewData() {
        try {
            const response = await fetch(`/api/server/${guildId}/settings`);
            const data = await response.json();

            if (data.success) {
                const settings = data.settings;

                const tier = settings.tier || 'free';
                const retentionDays = settings.retention_days || 1;

                const tierLabels = { 'premium': 'Premium', 'pro': 'Pro', 'grandfathered': 'Premium (Legacy)', 'free': 'Free' };
                document.getElementById('tier-status').textContent = tierLabels[tier] || tier;
                document.getElementById('tier-status').style.color = tier !== 'free' ? '#10B981' : '#8B949E';

                document.getElementById('dashboard-access').textContent = tier !== 'free' ? 'Enabled' : 'Upgrade Required';
                document.getElementById('dashboard-access').style.color = tier !== 'free' ? '#10B981' : '#F59E0B';

                const retentionText = retentionDays >= 30 ? '30 days' : (retentionDays >= 7 ? '7 days' : '24 hours');
                document.getElementById('retention-days').textContent = retentionText;

                const pruneLogs = settings.auto_prune_logs_days || 0;
                const pruneReports = settings.auto_prune_reports_days || 0;
                document.getElementById('prune-logs-status').textContent = pruneLogs > 0 ? `Every ${pruneLogs} Days` : 'Disabled';
                document.getElementById('prune-reports-status').textContent = pruneReports > 0 ? `Every ${pruneReports} Days` : 'Disabled';

                // Cancellation logic
                if (settings.cancel_at_period_end) {
                    document.getElementById('cancellation-warning-row').style.display = 'flex';
                    let dateStr = 'period end';
                    if (settings.current_period_end) {
                        const date = new Date(settings.current_period_end * 1000);
                        dateStr = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                    }
                    document.getElementById('cancellation-warning').textContent = `Canceling on ${dateStr}`;

                    if (userRole === 'admin') {
                        document.getElementById('subscription-actions').style.display = 'block';
                        document.getElementById('subscription-actions').innerHTML = `
                        <button onclick="resumeSubscription()" class="btn btn-secondary" style="width: 100%; margin-top: 8px;">Resume Subscription</button>
                    `;
                    }
                } else if (tier === 'premium' || tier === 'pro') {
                    document.getElementById('cancellation-warning-row').style.display = 'none';

                    if (userRole === 'admin') {
                        document.getElementById('subscription-actions').style.display = 'block';
                        document.getElementById('subscription-actions').innerHTML = `
                        <button onclick="cancelSubscription()" class="btn" style="width: 100%; margin-top: 8px; background: transparent; border: 1px solid #ef4444; color: #ef4444;">Cancel Subscription</button>
                    `;
                    }
                } else {
                    document.getElementById('cancellation-warning-row').style.display = 'none';
                    document.getElementById('subscription-actions').style.display = 'none';
                }
            }

            if (userRole === 'admin') {
                const empResponse = await fetch(`/api/server/${guildId}/employees`);
                const empData = await empResponse.json();

                if (empData.success) {
                    const employees = empData.employees || [];
                    const activeCount = employees.filter(e => e.is_active).length;
                    const clockedIn = employees.filter(e => e.is_clocked_in).length;

                    document.getElementById('employee-count').textContent = activeCount;
                    document.getElementById('clocked-in-count').textContent = clockedIn;
                    document.getElementById('clocked-in-count').style.color = clockedIn > 0 ? '#10B981' : '#8B949E';
                }

                const rolesResponse = await fetch(`/api/server/${guildId}/roles`);
                const rolesData = await rolesResponse.json();

                if (rolesData.success) {
                    const adminRoles = rolesData.admin_roles || [];
                    const employeeRoles = rolesData.employee_roles || [];

                    document.getElementById('admin-roles-preview').textContent =
                        adminRoles.length > 0 ? `${adminRoles.length} role(s) configured` : 'No roles configured';
                    document.getElementById('employee-roles-preview').textContent =
                        employeeRoles.length > 0 ? `${employeeRoles.length} role(s) configured` : 'No roles configured';
                }
            } else {
                document.getElementById('employee-count').textContent = '--';
                document.getElementById('clocked-in-count').textContent = '--';
            }
        } catch (error) {
            console.error('Failed to load overview:', error);
        }
    }

    async function cancelSubscription() {
        if (!confirm('Are you sure you want to cancel your subscription? You will retain access until the end of your current billing period.')) {
            return;
        }

        try {
            const response = await fetch(`/api/server/${guildId}/subscription/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                alert('Subscription canceled. You will retain access until the end of the billing period.');
                loadOverviewData();
            } else {
                alert(data.error || data.demo_note || 'Failed to cancel subscription.');
            }
        } catch (error) {
            console.error('Cancel error:', error);
            alert('An error occurred while canceling the subscription.');
        }
    }

    async function resumeSubscription() {
        if (!confirm('Are you sure you want to resume your subscription? Your regular billing will continue.')) {
            return;
        }

        try {
            const response = await fetch(`/api/server/${guildId}/subscription/resume`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                alert('Subscription resumed successfully.');
                loadOverviewData();
            } else {
                alert(data.error || data.demo_note || 'Failed to resume subscription.');
            }
        } catch (error) {
            console.error('Resume error:', error);
            alert('An error occurred while resuming the subscription.');
        }
    }

    document.addEventListener('DOMContentLoaded', loadOverviewData);
</script>
{% endblock %}