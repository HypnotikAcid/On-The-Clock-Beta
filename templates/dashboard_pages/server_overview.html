{% extends "dashboard_base.html" %}

{% block title %}{{ server.name }} - Overview{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">Server Overview</h1>
    <p class="content-subtitle">{{ server.name }}</p>
</div>

<div class="tiles-grid">
    <div class="tile" id="subscription-tile">
        <h2><span class="tile-icon">ðŸ’Ž</span>Subscription Status</h2>
        <div class="stat-row">
            <span class="stat-label">Tier:</span>
            <span class="stat-value" id="tier-status">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Dashboard Access:</span>
            <span class="stat-value" id="dashboard-access">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Data Retention:</span>
            <span class="stat-value" id="retention-days">Loading...</span>
        </div>
        <div class="stat-row" id="cancellation-warning-row" style="display: none;">
            <span class="stat-label">Status:</span>
            <span class="stat-value" id="cancellation-warning" style="color: #ef4444; font-weight: bold;">Canceling on
                period end</span>
        </div>
        <div id="subscription-actions" style="margin-top: 15px; display: none;">
            <!-- Buttons injected here by JS -->
        </div>
    </div>

    <div class="tile" id="quick-stats-tile">
        <h2><span class="tile-icon">ðŸ“Š</span>Quick Stats</h2>
        <div class="stat-row">
            <span class="stat-label">Active Employees:</span>
            <span class="stat-value" id="employee-count">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Currently Clocked In:</span>
            <span class="stat-value" id="clocked-in-count">Loading...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Pending Adjustments:</span>
            <span class="stat-value" id="pending-adjustments">{{ pending_adjustments }}</span>
        </div>
    </div>

    {% if user_role == 'admin' %}
    <div class="tile" id="admin-roles-tile">
        <h2><span class="tile-icon">ðŸ‘¥</span>Admin Roles</h2>
        <p class="tile-description">Manage who has admin access</p>
        <div id="admin-roles-preview">Loading...</div>
        <a href="/dashboard/server/{{ server.id }}/admin-roles" class="tile-link">Manage Admin Roles &rarr;</a>
    </div>

    <div class="tile" id="employee-roles-tile">
        <h2><span class="tile-icon">ðŸ‘·</span>Employee Roles</h2>
        <p class="tile-description">Manage employee role access</p>
        <div id="employee-roles-preview">Loading...</div>
        <a href="/dashboard/server/{{ server.id }}/employee-roles" class="tile-link">Manage Employee Roles &rarr;</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block page_scripts %}
<script>
    const guildId = '{{ server.id }}';
    const userRole = '{{ user_role }}';

    async function loadOverviewData() {
        try {
            const response = await fetch(`/api/server/${guildId}/settings`);
            const data = await response.json();

            if (data.success) {
                const settings = data.settings;

                const tier = settings.tier || 'free';
                const retentionDays = settings.retention_days || 1;

                const tierLabels = { 'premium': 'Premium', 'pro': 'Pro', 'grandfathered': 'Premium (Legacy)', 'free': 'Free' };
                document.getElementById('tier-status').textContent = tierLabels[tier] || tier;
                document.getElementById('tier-status').style.color = tier !== 'free' ? '#10B981' : '#8B949E';

                document.getElementById('dashboard-access').textContent = tier !== 'free' ? 'Enabled' : 'Upgrade Required';
                document.getElementById('dashboard-access').style.color = tier !== 'free' ? '#10B981' : '#F59E0B';

                const retentionText = retentionDays >= 30 ? '30 days' : (retentionDays >= 7 ? '7 days' : '24 hours');
                document.getElementById('retention-days').textContent = retentionText;

                // Cancellation logic
                if (settings.cancel_at_period_end) {
                    document.getElementById('cancellation-warning-row').style.display = 'flex';
                    let dateStr = 'period end';
                    if (settings.current_period_end) {
                        const date = new Date(settings.current_period_end * 1000);
                        dateStr = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                    }
                    document.getElementById('cancellation-warning').textContent = `Canceling on ${dateStr}`;

                    if (userRole === 'admin') {
                        document.getElementById('subscription-actions').style.display = 'block';
                        document.getElementById('subscription-actions').innerHTML = `
                        <button onclick="resumeSubscription()" class="btn btn-secondary" style="width: 100%; margin-top: 8px;">Resume Subscription</button>
                    `;
                    }
                } else if (tier === 'premium' || tier === 'pro') {
                    document.getElementById('cancellation-warning-row').style.display = 'none';

                    if (userRole === 'admin') {
                        document.getElementById('subscription-actions').style.display = 'block';
                        document.getElementById('subscription-actions').innerHTML = `
                        <button onclick="cancelSubscription()" class="btn" style="width: 100%; margin-top: 8px; background: transparent; border: 1px solid #ef4444; color: #ef4444;">Cancel Subscription</button>
                    `;
                    }
                } else {
                    document.getElementById('cancellation-warning-row').style.display = 'none';
                    document.getElementById('subscription-actions').style.display = 'none';
                }
            }

            if (userRole === 'admin') {
                const empResponse = await fetch(`/api/server/${guildId}/employees`);
                const empData = await empResponse.json();

                if (empData.success) {
                    const employees = empData.employees || [];
                    const activeCount = employees.filter(e => e.is_active).length;
                    const clockedIn = employees.filter(e => e.is_clocked_in).length;

                    document.getElementById('employee-count').textContent = activeCount;
                    document.getElementById('clocked-in-count').textContent = clockedIn;
                    document.getElementById('clocked-in-count').style.color = clockedIn > 0 ? '#10B981' : '#8B949E';
                }

                const rolesResponse = await fetch(`/api/server/${guildId}/roles`);
                const rolesData = await rolesResponse.json();

                if (rolesData.success) {
                    const adminRoles = rolesData.admin_roles || [];
                    const employeeRoles = rolesData.employee_roles || [];

                    document.getElementById('admin-roles-preview').textContent =
                        adminRoles.length > 0 ? `${adminRoles.length} role(s) configured` : 'No roles configured';
                    document.getElementById('employee-roles-preview').textContent =
                        employeeRoles.length > 0 ? `${employeeRoles.length} role(s) configured` : 'No roles configured';
                }
            } else {
                document.getElementById('employee-count').textContent = '--';
                document.getElementById('clocked-in-count').textContent = '--';
            }
        } catch (error) {
            console.error('Failed to load overview:', error);
        }
    }

    async function cancelSubscription() {
        if (!confirm('Are you sure you want to cancel your subscription? You will retain access until the end of your current billing period.')) {
            return;
        }

        try {
            const response = await fetch(`/api/server/${guildId}/subscription/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                alert('Subscription canceled. You will retain access until the end of the billing period.');
                loadOverviewData();
            } else {
                alert(data.error || data.demo_note || 'Failed to cancel subscription.');
            }
        } catch (error) {
            console.error('Cancel error:', error);
            alert('An error occurred while canceling the subscription.');
        }
    }

    async function resumeSubscription() {
        if (!confirm('Are you sure you want to resume your subscription? Your regular billing will continue.')) {
            return;
        }

        try {
            const response = await fetch(`/api/server/${guildId}/subscription/resume`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                alert('Subscription resumed successfully.');
                loadOverviewData();
            } else {
                alert(data.error || data.demo_note || 'Failed to resume subscription.');
            }
        } catch (error) {
            console.error('Resume error:', error);
            alert('An error occurred while resuming the subscription.');
        }
    }

    document.addEventListener('DOMContentLoaded', loadOverviewData);
</script>
{% endblock %}