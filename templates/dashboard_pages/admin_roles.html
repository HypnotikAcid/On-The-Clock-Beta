{% extends "dashboard_base.html" %}

{% block title %}{{ server.name }} - Admin Roles{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">Admin Roles <span class="info-tooltip"
            data-tooltip="Roles added here will have full access to the dashboard. They can configure the server, view all employee data, and alter timesheets.">?</span>
    </h1>
    <p class="content-subtitle">Manage which roles have admin access to reports and settings</p>
</div>

<div class="tiles-grid">
    <div class="tile">
        <h2><span class="tile-icon">ðŸ‘¥</span>Current Admin Roles</h2>
        <p class="tile-description">These roles can access Reports, Settings, and Upgrade functions</p>

        <div id="admin-roles-list" class="roles-list">
            <div class="loading-placeholder">Loading roles...</div>
        </div>
    </div>

    <div class="tile">
        <h2><span class="tile-icon">âž•</span>Add Admin Role</h2>
        <p class="tile-description">Select a role to grant admin access</p>

        <div class="form-group">
            <label for="role-select">Select Role:</label>
            <select id="role-select" class="form-select">
                <option value="">-- Select a role --</option>
            </select>
        </div>

        <button id="add-role-btn" class="btn btn-primary" disabled>Add Admin Role</button>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    const guildId = '{{ server.id }}';
    let allRoles = [];
    let adminRoleIds = [];

    async function loadRoles() {
        try {
            const response = await fetch(`/api/server/${guildId}/roles`);
            const data = await response.json();

            if (data.success) {
                allRoles = data.all_roles || [];
                adminRoleIds = (data.admin_roles || []).map(r => r.id);

                renderAdminRoles(data.admin_roles || []);
                populateRoleSelect();
            }
        } catch (error) {
            console.error('Failed to load roles:', error);
            document.getElementById('admin-roles-list').innerHTML =
                '<p class="error-text">Failed to load roles. Please refresh.</p>';
        }
    }

    function renderAdminRoles(roles) {
        const container = document.getElementById('admin-roles-list');

        if (roles.length === 0) {
            container.innerHTML = '<p class="empty-state-text">No admin roles configured</p>';
            return;
        }

        container.innerHTML = roles.map(role => `
        <div class="role-item">
            <span class="role-name" style="color: ${role.color || '#C9D1D9'}">
                ${DashboardUtils.escapeHtml(role.name)}
            </span>
            <button class="btn btn-danger btn-sm" onclick="removeRole('${role.id}')">Remove</button>
        </div>
    `).join('');
    }

    function populateRoleSelect() {
        const select = document.getElementById('role-select');
        const availableRoles = allRoles.filter(r => !adminRoleIds.includes(r.id) && r.name !== '@everyone');

        select.innerHTML = '<option value="">-- Select a role --</option>' +
            availableRoles.map(r =>
                `<option value="${r.id}" style="color: ${r.color || '#C9D1D9'}">${DashboardUtils.escapeHtml(r.name)}</option>`
            ).join('');

        document.getElementById('add-role-btn').disabled = availableRoles.length === 0;
    }

    document.getElementById('role-select').addEventListener('change', function () {
        document.getElementById('add-role-btn').disabled = !this.value;
    });

    document.getElementById('add-role-btn').addEventListener('click', async function () {
        const roleId = document.getElementById('role-select').value;
        if (!roleId) return;

        this.disabled = true;
        this.textContent = 'Adding...';

        try {
            const response = await fetch(`/api/server/${guildId}/admin-roles/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role_id: roleId })
            });

            const data = await response.json();

            if (data.success) {
                DashboardUtils.showNotification('Admin role added successfully', 'success');
                loadRoles();
            } else {
                DashboardUtils.showNotification(data.error || 'Failed to add role', 'error');
            }
        } catch (error) {
            DashboardUtils.showNotification('Failed to add role', 'error');
        }

        this.disabled = false;
        this.textContent = 'Add Admin Role';
    });

    async function removeRole(roleId) {
        if (!confirm('Remove this admin role?')) return;

        try {
            const response = await fetch(`/api/server/${guildId}/admin-roles/remove`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role_id: roleId })
            });

            const data = await response.json();

            if (data.success) {
                DashboardUtils.showNotification('Admin role removed', 'success');
                loadRoles();
            } else {
                DashboardUtils.showNotification(data.error || 'Failed to remove role', 'error');
            }
        } catch (error) {
            DashboardUtils.showNotification('Failed to remove role', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', loadRoles);
</script>
{% endblock %}