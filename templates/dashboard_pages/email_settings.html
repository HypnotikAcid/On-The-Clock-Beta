{% extends "dashboard_base.html" %}

{% block title %}{{ server.name }} - Email Settings{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">Email Settings</h1>
    <p class="content-subtitle">Configure automated report delivery</p>
</div>

<div class="tiles-grid">
    <div class="tile">
        <h2><span class="tile-icon">üìß</span>Email Recipients</h2>
        <p class="tile-description">Email addresses that receive automated reports</p>
        
        <div id="recipients-list" class="recipients-list">
            <div class="loading-placeholder">Loading recipients...</div>
        </div>
        
        <div class="form-group" style="margin-top: 20px;">
            <label for="new-email">Add Email:</label>
            <div class="input-group">
                <input type="email" id="new-email" class="form-input" placeholder="email@example.com">
                <button id="add-email-btn" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>

    <div class="tile">
        <h2><span class="tile-icon">‚öôÔ∏è</span>Report Settings</h2>
        
        <div class="setting-row">
            <div class="setting-info">
                <span class="setting-label">Auto-send on clock-out</span>
                <span class="setting-description">Send report when last employee clocks out</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="auto-send-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="setting-row" style="margin-top: 20px;">
            <button id="test-email-btn" class="btn btn-secondary">
                <span>üì§</span> Send Test Email
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
const guildId = '{{ server.id }}';

async function loadEmailSettings() {
    const container = document.getElementById('recipients-list');
    const autoSendToggle = document.getElementById('auto-send-toggle');
    
    try {
        const response = await fetch(`/api/server/${guildId}/email-recipients`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        
        if (data.success) {
            renderRecipients(data.emails || []);
        } else {
            container.innerHTML = `<p class="error-text">Failed to load: ${data.error || 'Unknown error'}</p>`;
        }
    } catch (error) {
        console.error('Failed to load email recipients:', error);
        container.innerHTML = `<p class="error-text">Connection error. Please try again.</p>`;
    }
    
    try {
        const settingsResponse = await fetch(`/api/server/${guildId}/email-settings-status`);
        if (!settingsResponse.ok) {
            console.warn('Failed to load email settings status');
            return;
        }
        const settingsData = await settingsResponse.json();
        if (settingsData.success) {
            autoSendToggle.checked = settingsData.auto_send_on_clockout !== false;
        }
    } catch (error) {
        console.error('Failed to load email settings status:', error);
    }
}

function renderRecipients(emails) {
    const container = document.getElementById('recipients-list');
    
    if (!emails || emails.length === 0) {
        container.innerHTML = '<p class="empty-state-text">No email recipients configured</p>';
        return;
    }
    
    container.innerHTML = emails.map(r => {
        const isPending = r.verification_status === 'pending';
        const statusBadge = isPending 
            ? '<span class="badge badge-warning">Pending Verification</span>'
            : '<span class="badge badge-success">Verified</span>';
        
        const verifyInput = isPending ? `
            <div class="verify-row" style="margin-top: 8px;">
                <input type="text" class="form-input form-input-sm verify-code-input" 
                       id="verify-code-${r.id}" placeholder="Enter 6-digit code" maxlength="6" 
                       style="width: 140px; display: inline-block;">
                <button class="btn btn-primary btn-sm" onclick="verifyEmail('${r.id}')">Verify</button>
                <button class="btn btn-secondary btn-sm" onclick="resendCode('${r.id}')">Resend Code</button>
            </div>
        ` : '';
        
        return `
            <div class="recipient-item" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; align-items: center; gap: 10px; width: 100%; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="recipient-email">${DashboardUtils.escapeHtml(r.email)}</span>
                        ${statusBadge}
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeRecipient('${r.id}')">Remove</button>
                </div>
                ${verifyInput}
            </div>
        `;
    }).join('');
}

async function verifyEmail(recipientId) {
    const codeInput = document.getElementById(`verify-code-${recipientId}`);
    const code = codeInput.value.trim();
    
    if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
        DashboardUtils.showNotification('Please enter the 6-digit code from your email', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/server/${guildId}/email-recipients/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: recipientId, code: code })
        });
        
        const data = await response.json();
        
        if (data.success) {
            DashboardUtils.showNotification('Email verified successfully!', 'success');
            loadEmailSettings();
        } else {
            DashboardUtils.showNotification(data.error || 'Verification failed', 'error');
        }
    } catch (error) {
        DashboardUtils.showNotification('Failed to verify email', 'error');
    }
}

async function resendCode(recipientId) {
    try {
        const response = await fetch(`/api/server/${guildId}/email-recipients/resend`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: recipientId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            DashboardUtils.showNotification('New verification code sent!', 'success');
        } else {
            DashboardUtils.showNotification(data.error || 'Failed to resend code', 'error');
        }
    } catch (error) {
        DashboardUtils.showNotification('Failed to resend code', 'error');
    }
}

document.getElementById('add-email-btn').addEventListener('click', async function() {
    const email = document.getElementById('new-email').value.trim();
    if (!email || !email.includes('@')) {
        DashboardUtils.showNotification('Please enter a valid email address', 'error');
        return;
    }
    
    this.disabled = true;
    
    try {
        const response = await fetch(`/api/server/${guildId}/email-recipients/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('new-email').value = '';
            DashboardUtils.showNotification('Email added! Check your inbox for a 6-digit verification code.', 'success');
            loadEmailSettings();
        } else {
            DashboardUtils.showNotification(data.error || 'Failed to add email', 'error');
        }
    } catch (error) {
        DashboardUtils.showNotification('Failed to add email', 'error');
    }
    
    this.disabled = false;
});

async function removeRecipient(recipientId) {
    if (!confirm('Remove this email recipient?')) return;
    
    try {
        const response = await fetch(`/api/server/${guildId}/email-recipients/remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recipient_id: recipientId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            DashboardUtils.showNotification('Email recipient removed', 'success');
            loadEmailSettings();
        } else {
            DashboardUtils.showNotification(data.error || 'Failed to remove', 'error');
        }
    } catch (error) {
        DashboardUtils.showNotification('Failed to remove', 'error');
    }
}

document.getElementById('auto-send-toggle').addEventListener('change', async function() {
    try {
        const response = await fetch(`/api/server/${guildId}/email-settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ auto_send_on_clockout: this.checked })
        });
        
        const data = await response.json();
        
        if (data.success) {
            DashboardUtils.showNotification('Settings updated', 'success');
        } else {
            this.checked = !this.checked;
            DashboardUtils.showNotification(data.error || 'Failed to update', 'error');
        }
    } catch (error) {
        this.checked = !this.checked;
        DashboardUtils.showNotification('Failed to update', 'error');
    }
});

document.getElementById('test-email-btn').addEventListener('click', async function() {
    if (this.disabled) return;
    
    this.disabled = true;
    const originalHTML = this.innerHTML;
    this.innerHTML = '<span class="spinner-inline"></span> Sending...';
    
    try {
        const response = await fetch(`/api/server/${guildId}/test-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            DashboardUtils.showNotification(`Test email sent successfully to ${data.sent_count} recipient(s)`, 'success');
        } else {
            DashboardUtils.showNotification(data.error || 'Failed to send test email. Make sure you have recipients added.', 'error');
        }
    } catch (error) {
        console.error('Test email failed:', error);
        DashboardUtils.showNotification('Connection error while sending test email.', 'error');
    } finally {
        this.disabled = false;
        this.innerHTML = originalHTML;
    }
});

document.addEventListener('DOMContentLoaded', loadEmailSettings);
</script>
{% endblock %}
