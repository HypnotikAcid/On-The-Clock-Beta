<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %} - Time Warden</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    {% block extra_css %}{% endblock %}
</head>

<body data-user-id="{{ user.user_id if user else '' }}" data-guild-id="{{ server.id if server else '' }}"
    data-tier="{{ server_settings.tier if server_settings else 'free' }}">
    <div id="matrix-toggle" onclick="toggleMatrix()"
        style="position: fixed; top: 1rem; right: 1rem; z-index: 1001; cursor: pointer; background: rgba(10, 15, 31, 0.7); padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(0, 255, 255, 0.3); font-size: 0.75rem; color: rgba(0, 255, 255, 0.8); display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; user-select: none;">
        <span id="matrix-toggle-text">Exit The Matrix</span>
        <div
            style="width: 30px; height: 16px; background: rgba(0, 255, 255, 0.1); border-radius: 10px; position: relative; border: 1px solid rgba(0, 255, 255, 0.3);">
            <div id="matrix-toggle-knob"
                style="width: 10px; height: 10px; background: #00FFFF; border-radius: 50%; position: absolute; top: 2px; right: 3px; transition: all 0.3s ease; box-shadow: 0 0 8px #00FFFF;">
            </div>
        </div>
    </div>
    <a href="https://buymeacoffee.com/hypnotik" target="_blank" rel="noopener noreferrer" id="coffee-btn-fixed"
        style="position: fixed; top: 3.5rem; right: 1rem; z-index: 1001; display: inline-flex; align-items: center; gap: 6px; background: rgba(255, 221, 0, 0.9); color: #000; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; text-decoration: none; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(255, 221, 0, 0.3); border: 1px solid rgba(0, 0, 0, 0.2);">
        <span style="font-size: 1rem;">â˜•</span>
        <span>Buy Me a Coffee</span>
    </a>
    {% if is_demo_server and server %}
    <div id="demo-view-toggle"
        style="position: fixed; top: 6rem; right: 1rem; z-index: 1001; background: rgba(10, 15, 31, 0.9); padding: 8px 14px; border-radius: 12px; border: 1px solid rgba(212, 175, 55, 0.5); font-size: 0.75rem; color: rgba(212, 175, 55, 0.9);">
        <div style="font-weight: 600; margin-bottom: 6px; text-align: center;">Demo Mode</div>
        <div style="display: flex; gap: 6px;">
            <a href="/dashboard/server/{{ server.id }}?view_as=admin"
                style="padding: 4px 10px; border-radius: 6px; text-decoration: none; font-size: 0.7rem; {% if not view_as_employee %}background: rgba(212, 175, 55, 0.3); color: #D4AF37; border: 1px solid #D4AF37;{% else %}background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.1);{% endif %}">Admin
                View</a>
            <a href="/dashboard/server/{{ server.id }}?view_as=employee"
                style="padding: 4px 10px; border-radius: 6px; text-decoration: none; font-size: 0.7rem; {% if view_as_employee %}background: rgba(0, 255, 255, 0.3); color: #00FFFF; border: 1px solid #00FFFF;{% else %}background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.1);{% endif %}">Employee
                View</a>
        </div>
        {% if last_demo_reset %}
        <div
            style="margin-top: 8px; padding-top: 6px; border-top: 1px solid rgba(212, 175, 55, 0.3); font-size: 0.65rem; color: rgba(255,255,255,0.5); text-align: center;">
            Last reset: {{ last_demo_reset.strftime('%b %d, %H:%M UTC') if last_demo_reset else 'Never' }}<br>
            <span style="color: rgba(16, 185, 129, 0.8);">Auto-resets daily at midnight UTC</span>
        </div>
        {% endif %}
    </div>
    {% endif %}
    <div id="matrix-container" aria-hidden="true">
        <canvas id="matrix-canvas"></canvas>
        <div class="clock-fade-mask"></div>
        <div class="clock-background">
            <div class="clock-container" id="clockContainer">
                <div class="clock-face"></div>
                <div class="hour-marker major" style="transform: rotate(0deg);"></div>
                <div class="hour-marker" style="transform: rotate(30deg);"></div>
                <div class="hour-marker" style="transform: rotate(60deg);"></div>
                <div class="hour-marker major" style="transform: rotate(90deg);"></div>
                <div class="hour-marker" style="transform: rotate(120deg);"></div>
                <div class="hour-marker" style="transform: rotate(150deg);"></div>
                <div class="hour-marker major" style="transform: rotate(180deg);"></div>
                <div class="hour-marker" style="transform: rotate(210deg);"></div>
                <div class="hour-marker" style="transform: rotate(240deg);"></div>
                <div class="hour-marker major" style="transform: rotate(270deg);"></div>
                <div class="hour-marker" style="transform: rotate(300deg);"></div>
                <div class="hour-marker" style="transform: rotate(330deg);"></div>
                <div class="hour-hand clock-hand" id="hourHand"></div>
                <div class="minute-hand clock-hand" id="minuteHand"></div>
                <div class="second-hand clock-hand" id="secondHand"></div>
                <div class="clock-center"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar is now OUTSIDE layout-container for proper z-index stacking -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">âš™ï¸</span>
            <div class="sidebar-logo-text">Time Warden<br>Dashboard</div>
        </div>

        <nav class="sidebar-nav">
            {% if server %}
            <a href="/dashboard" class="back-to-servers">
                <span>&larr;</span>
                <span>Back to Servers</span>
            </a>
            <div class="server-nav-header">
                <div class="server-nav-icon">
                    {% if server.icon %}
                    <img src="https://cdn.discordapp.com/icons/{{ server.id }}/{{ server.icon }}.png?size=64"
                        alt="{{ server.name }}" style="width: 100%; height: 100%; border-radius: 50%;">
                    {% else %}
                    {{ server.name[0]|upper }}
                    {% endif %}
                </div>
                <div class="server-nav-name">{{ server.name }}</div>
            </div>
            <div class="nav-section-title">Server Settings</div>

            <a href="/dashboard/server/{{ server.id }}"
                class="nav-item {% if active_page == 'overview' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ“Š</span>
                <span>Server Overview</span>
            </a>

            {% if user_role == 'admin' %}
            <a href="/dashboard/server/{{ server.id }}/admin-roles"
                class="nav-item {% if active_page == 'admin-roles' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ‘¥</span>
                <span>Admin Roles</span>
            </a>
            <a href="/dashboard/server/{{ server.id }}/employee-roles"
                class="nav-item {% if active_page == 'employee-roles' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ‘·</span>
                <span>Employee Roles</span>
            </a>
            <a href="/dashboard/server/{{ server.id }}/email"
                class="nav-item {% if active_page == 'email' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ“§</span>
                <span>Email Settings</span>
            </a>
            <a href="/dashboard/server/{{ server.id }}/timezone"
                class="nav-item {% if active_page == 'timezone' %}active{% endif %}">
                <span class="nav-item-icon">â°</span>
                <span>Timezone Settings</span>
                {% if show_tz_reminder %}
                <span class="badge"
                    style="background:#F59E0B; color:#111; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; margin-left:auto;">Set
                    TZ!</span>
                {% endif %}
            </a>
            <a href="/dashboard/server/{{ server.id }}/employees"
                class="nav-item {% if active_page == 'employees' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ‘¥</span>
                <span>Employee Status</span>
            </a>
            {% endif %}

            {% if user_role == 'employee' or (user_role == 'admin' and is_also_employee) %}
            <a href="/dashboard/server/{{ server.id }}/profile/{{ user.user_id }}"
                class="nav-item {% if active_page == 'my-info' or active_page == 'profile' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ‘¤</span>
                <span>My Info</span>
            </a>
            {% endif %}

            <a href="/dashboard/server/{{ server.id }}/adjustments"
                class="nav-item {% if active_page == 'adjustments' %}active{% endif %}">
                <span class="nav-item-icon">â³</span>
                <span>Time Adjustments</span>
                {% if pending_adjustments > 0 %}
                <span class="badge"
                    style="background: #EF4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: auto;">{{
                    pending_adjustments }}</span>
                {% endif %}
            </a>

            <a href="/dashboard/server/{{ server.id }}/reports"
                class="nav-item {% if active_page == 'reports' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ“„</span>
                <span>Reports & Exports</span>
            </a>

            <a href="/dashboard/server/{{ server.id }}/integrations"
                class="nav-item {% if active_page == 'integrations' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ”Œ</span>
                <span>Discord Integrations</span>
            </a>

            {% if active_page == 'calendar' and server %}
            {% if user_role == 'admin' %}
            <a href="/dashboard/server/{{ server.id }}/calendar"
                class="nav-item {% if active_page == 'calendar' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ“…</span>
                <span>Admin Calendar</span>
            </a>
            <a href="/dashboard/server/{{ server.id }}/bans"
                class="nav-item {% if active_page == 'bans' %}active{% endif %}">
                <span class="nav-item-icon">ğŸš«</span>
                <span>Ban Management</span>
            </a>

            {% if server_settings.tier in ['pro', 'premium', 'grandfathered'] or is_demo_server %}
            <a href="/dashboard/server/{{ server.id }}/kiosk"
                class="nav-item {% if active_page == 'kiosk' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ–¥ï¸</span>
                <span>Kiosk Settings</span>
            </a>
            {% else %}
            <a href="/dashboard/purchase?guild_id={{ server.id }}" class="nav-item locked-item"
                title="Requires Pro Tier">
                <span class="nav-item-icon">ğŸ–¥ï¸</span>
                <span style="color: #6e7681;">Kiosk Settings ğŸ”’</span>
            </a>
            {% endif %}

            <a href="/dashboard/server/{{ server.id }}/beta"
                class="nav-item {% if active_page == 'beta' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ§ª</span>
                <span>Beta Settings</span>
            </a>
            {% endif %}
            {% endif %}

            {% else %}
            <div class="nav-section-title">Navigation</div>
            <a href="/dashboard" class="nav-item {% if active_page == 'my-servers' %}active{% endif %}">
                <span class="nav-item-icon">ğŸ¢</span>
                <span>My Servers</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" id="start-tour-nav">
                <span class="nav-item-icon">âœ¨</span>
                <span>Take the Tour</span>
            </a>
            {% endif %}
        </nav>

        <div class="sidebar-user">
            <div class="sidebar-user-avatar">
                {% if user.avatar %}
                <img src="https://cdn.discordapp.com/avatars/{{ user.user_id }}/{{ user.avatar }}.png?size=128"
                    alt="Avatar">
                {% else %}
                {{ user.username[0]|upper }}
                {% endif %}
            </div>
            <div class="sidebar-user-info">
                <div class="sidebar-user-name">{{ user.username }}</div>
                <div class="sidebar-user-id">{{ user.user_id[:8] }}...</div>
            </div>
            <a href="/auth/logout" class="logout-icon" title="Logout">ğŸšª</a>
        </div>
        <div style="padding: 10px 20px; border-top: 1px solid rgba(255,255,255,0.05);">
            <button onclick="DashboardTour.reset()" class="btn-secondary"
                style="width: 100%; font-size: 0.75rem; padding: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span>ğŸ”„</span> Reset Onboarding
            </button>
        </div>
    </aside>

    <!-- Mobile overlay - catches taps to close sidebar -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Main content area -->
    <div class="layout-container">
        <main class="content-area">
            {% block content %}{% endblock %}
        </main>

        {% if server_settings and not server_settings.bot_access_paid %}
        <div class="ad-container" id="dashboard-ad-container">
            <div class="ad-placeholder">
                <span class="ad-label">Advertisement</span>
                <div class="ad-content">
                    <a href="/auth/login" class="ad-upgrade-link">
                        Upgrade to Premium for an ad-free experience
                    </a>
                </div>
            </div>
        </div>
        <style>
            .ad-container {
                position: fixed;
                bottom: 0;
                left: 260px;
                right: 0;
                background: linear-gradient(180deg, rgba(22, 27, 34, 0.95), #161b22);
                border-top: 1px solid rgba(212, 175, 55, 0.2);
                padding: 12px 20px;
                z-index: 100;
                text-align: center;
            }

            .ad-placeholder {
                max-width: 728px;
                margin: 0 auto;
            }

            .ad-label {
                font-size: 10px;
                color: #6e7681;
                text-transform: uppercase;
                letter-spacing: 1px;
                display: block;
                margin-bottom: 4px;
            }

            .ad-content {
                min-height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(30, 35, 45, 0.5);
                border-radius: 8px;
                border: 1px dashed rgba(212, 175, 55, 0.3);
            }

            .ad-upgrade-link {
                color: #D4AF37;
                text-decoration: none;
                font-size: 14px;
                transition: color 0.2s;
            }

            .ad-upgrade-link:hover {
                color: #F4E5A1;
            }

            .content-area {
                padding-bottom: 100px !important;
            }

            @media (max-width: 1024px) {
                .ad-container {
                    left: 0;
                }
            }
        </style>
        {% endif %}
    </div>

    <!-- Mobile hamburger button - always on top -->
    <div class="mobile-hamburger" id="mobileHamburger">
        <span class="hamburger-icon">â˜°</span>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <script src="/static/js/dashboard-matrix.js"></script>
    <script src="/static/js/dashboard-common.js"></script>
    {% block page_scripts %}{% endblock %}

    <script>
        (function () {
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const mobileHamburger = document.getElementById('mobileHamburger');

            function isMobile() {
                return window.innerWidth <= 1024;
            }

            function openSidebar() {
                document.body.classList.add('sidebar-open');
                sidebar.classList.remove('mobile-hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeSidebar() {
                document.body.classList.remove('sidebar-open');
                sidebar.classList.add('mobile-hidden');
                document.body.style.overflow = '';
            }

            function initSidebarState() {
                document.body.classList.remove('sidebar-open');
                document.body.style.overflow = '';
                if (isMobile()) {
                    sidebar.classList.add('mobile-hidden');
                } else {
                    sidebar.classList.remove('mobile-hidden');
                }
            }

            initSidebarState();

            if (mobileHamburger) {
                mobileHamburger.addEventListener('click', function (e) {
                    e.stopPropagation();
                    if (sidebar.classList.contains('mobile-hidden')) {
                        openSidebar();
                    } else {
                        closeSidebar();
                    }
                });
            }

            if (mobileOverlay) {
                mobileOverlay.addEventListener('click', function () {
                    closeSidebar();
                });
            }

            const navLinks = sidebar.querySelectorAll('.nav-item, .back-to-servers');
            navLinks.forEach(link => {
                link.addEventListener('click', function () {
                    if (isMobile()) {
                        closeSidebar();
                    }
                });
            });

            let resizeTimer;
            window.addEventListener('resize', function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function () {
                    document.body.classList.remove('sidebar-open');
                    document.body.style.overflow = '';
                    if (!isMobile()) {
                        sidebar.classList.remove('mobile-hidden');
                    } else {
                        sidebar.classList.add('mobile-hidden');
                    }
                }, 100);
            });
        })();
    </script>
    <script src="/static/js/dashboard-tour.js"></script>

    <style>
        /* Existing styles... */
    </style>

    <div id="page-help-modal" class="help-modal" onclick="closePageHelp()">
        <div class="help-modal-content" onclick="event.stopPropagation()">
            <button class="help-modal-close" onclick="closePageHelp()">&times;</button>
            <div id="page-help-content"></div>
        </div>
    </div>

    <script>
        /* Existing help modal JS... */

        // Wizard Trigger Logic
        document.addEventListener('DOMContentLoaded', function () {
            const wizardCompleted = localStorage.getItem('setup_wizard_completed');
            const wizardSkipped = localStorage.getItem('setup_wizard_skipped');
            const isFirstVisitToServer = !wizardCompleted && !wizardSkipped && GUILD_ID; // Only trigger if a server is selected

            if (isFirstVisitToServer && window.location.pathname !== '/setup-wizard') {
                window.location.href = '/setup-wizard?guild_id=' + GUILD_ID;
            }

            // Phase 9: Interactive Tour
            const hasCompletedOnboarding = {{ 'true' if has_completed_onboarding else 'false' }};
            if (!hasCompletedOnboarding && GUILD_ID && window.location.pathname !== '/setup-wizard') {
            setTimeout(() => {
                if (typeof DashboardTour !== 'undefined') {
                    DashboardTour.start();
                    // Mark as completed in the backend so it doesn't run again on reload
                    fetch(`/api/server/${GUILD_ID}/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ has_completed_onboarding: true })
                    }).catch(err => console.error("Failed to mark onboarding complete", err));
                }
            }, 1000);
        }

        // Phase 5: Admin Milestone Toasts
        const totalShifts = {{ total_shifts if total_shifts is defined else 0 }};
        const role = "{{ user_role if user_role is defined else '' }}";

        if (totalShifts >= 100 && role === 'admin') {
            const milestoneKey = `milestone_100_shown_${GUILD_ID}`;
            if (!localStorage.getItem(milestoneKey)) {
                setTimeout(() => {
                    DashboardUtils.showNotification(
                        "ğŸ‰ **Milestone Reached!** 100 shifts logged. Having a good time? <a href='https://top.gg/bot/1418446753379913809#reviews' target='_blank' style='color: #00FFFF; text-decoration: underline;'>Consider leaving a 5-star review!</a>",
                        "success",
                        10000 // Show for 10 seconds
                    );
                    localStorage.setItem(milestoneKey, 'true');
                }, 2000); // 2 second delay so it doesn't get lost in load animations
            }
        }
        });
    </script>
</body>

</html>