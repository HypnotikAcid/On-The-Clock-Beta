<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time Warden - Control Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0A0F1F 0%, #151B2E 50%, #1E2750 100%);
            color: #C9D1D9;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .kiosk-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
        }

        .kiosk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .kiosk-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .kiosk-logo-icon {
            font-size: 36px;
        }

        .kiosk-logo-text {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #D4AF37, #F4E5A1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .kiosk-time {
            font-size: 32px;
            font-weight: 600;
            color: #D4AF37;
        }

        .kiosk-date {
            font-size: 14px;
            color: #8B949E;
            text-align: right;
        }

        /* Screen States */
        .screen {
            display: none;
            flex: 1;
            padding-top: 30px;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* Employee Grid */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .employee-btn {
            background: rgba(30, 35, 45, 0.7);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            min-height: 160px;
        }

        .employee-btn:hover, .employee-btn:active {
            background: rgba(212, 175, 55, 0.15);
            border-color: rgba(212, 175, 55, 0.6);
            transform: scale(1.02);
        }

        .employee-btn.clocked-in {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.1);
        }

        .employee-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D4AF37, #F4E5A1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #0D1117;
            overflow: hidden;
        }

        .employee-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .employee-name {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            color: #C9D1D9;
        }

        .employee-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .employee-status.in {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }

        .employee-status.out {
            background: rgba(139, 148, 158, 0.2);
            color: #8B949E;
        }

        /* Accent color customization for employee buttons */
        .employee-btn.accent-cyan { border-color: rgba(0, 255, 255, 0.5); box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); }
        .employee-btn.accent-magenta { border-color: rgba(255, 0, 255, 0.5); box-shadow: 0 0 15px rgba(255, 0, 255, 0.3); }
        .employee-btn.accent-gold { border-color: rgba(212, 175, 55, 0.5); box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }
        .employee-btn.accent-green { border-color: rgba(0, 255, 65, 0.5); box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
        .employee-btn.accent-blue { border-color: rgba(0, 119, 255, 0.5); box-shadow: 0 0 15px rgba(0, 119, 255, 0.3); }
        .employee-btn.accent-red { border-color: rgba(255, 68, 68, 0.5); box-shadow: 0 0 15px rgba(255, 68, 68, 0.3); }
        .employee-btn.accent-purple { border-color: rgba(157, 0, 255, 0.5); box-shadow: 0 0 15px rgba(157, 0, 255, 0.3); }
        .employee-btn.accent-teal { border-color: rgba(0, 245, 255, 0.5); box-shadow: 0 0 15px rgba(0, 245, 255, 0.3); }
        
        .employee-btn.accent-cyan:hover { border-color: rgba(0, 255, 255, 0.8); box-shadow: 0 0 25px rgba(0, 255, 255, 0.5); }
        .employee-btn.accent-magenta:hover { border-color: rgba(255, 0, 255, 0.8); box-shadow: 0 0 25px rgba(255, 0, 255, 0.5); }
        .employee-btn.accent-gold:hover { border-color: rgba(212, 175, 55, 0.8); box-shadow: 0 0 25px rgba(212, 175, 55, 0.5); }
        .employee-btn.accent-green:hover { border-color: rgba(0, 255, 65, 0.8); box-shadow: 0 0 25px rgba(0, 255, 65, 0.5); }
        .employee-btn.accent-blue:hover { border-color: rgba(0, 119, 255, 0.8); box-shadow: 0 0 25px rgba(0, 119, 255, 0.5); }
        .employee-btn.accent-red:hover { border-color: rgba(255, 68, 68, 0.8); box-shadow: 0 0 25px rgba(255, 68, 68, 0.5); }
        .employee-btn.accent-purple:hover { border-color: rgba(157, 0, 255, 0.8); box-shadow: 0 0 25px rgba(157, 0, 255, 0.5); }
        .employee-btn.accent-teal:hover { border-color: rgba(0, 245, 255, 0.8); box-shadow: 0 0 25px rgba(0, 245, 255, 0.5); }

        /* PIN Pad Screen - inherits display from .screen/.screen.active */
        .pin-screen.active {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .pin-header {
            text-align: center;
        }

        .pin-title {
            font-size: 28px;
            font-weight: 700;
            color: #D4AF37;
            margin-bottom: 10px;
        }

        .pin-subtitle {
            font-size: 16px;
            color: #8B949E;
        }

        .pin-display {
            display: flex;
            gap: 15px;
        }

        .pin-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid rgba(212, 175, 55, 0.5);
            background: transparent;
            transition: all 0.2s ease;
        }

        .pin-dot.filled {
            background: #D4AF37;
            border-color: #D4AF37;
        }

        .pin-error {
            color: #EF4444;
            font-size: 14px;
            min-height: 20px;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 90px);
            gap: 15px;
        }

        .numpad-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: rgba(30, 35, 45, 0.7);
            color: #C9D1D9;
            font-size: 32px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .numpad-btn:hover, .numpad-btn:active {
            background: rgba(212, 175, 55, 0.2);
            border-color: rgba(212, 175, 55, 0.6);
            transform: scale(1.05);
        }

        .numpad-btn.special {
            font-size: 20px;
        }

        .numpad-btn.delete {
            color: #EF4444;
        }

        /* Forgot PIN Button */
        .forgot-pin-btn {
            margin-top: 20px;
            background: transparent;
            border: none;
            color: #8B949E;
            font-size: 14px;
            cursor: pointer;
            padding: 10px 20px;
            transition: color 0.2s ease;
        }

        .forgot-pin-btn:hover {
            color: #D4AF37;
        }

        /* Forgot PIN Modal */
        .forgot-pin-modal {
            background: linear-gradient(135deg, #1a1f2e 0%, #252b3d 100%);
            border: 2px solid rgba(239, 68, 68, 0.4);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            animation: modalSlide 0.3s ease;
            text-align: center;
            padding: 30px;
        }

        .forgot-pin-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .forgot-pin-title {
            font-size: 22px;
            font-weight: 700;
            color: #EF4444;
            margin-bottom: 15px;
        }

        .forgot-pin-text {
            color: #C9D1D9;
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .forgot-pin-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .forgot-pin-confirm {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            transition: all 0.2s ease;
        }

        .forgot-pin-confirm:hover {
            transform: scale(1.05);
        }

        .forgot-pin-cancel {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(139, 148, 158, 0.3);
            color: #C9D1D9;
            transition: all 0.2s ease;
        }

        .forgot-pin-cancel:hover {
            background: rgba(139, 148, 158, 0.5);
        }

        /* Email Alert Badge */
        .employee-btn {
            position: relative;
        }

        .email-alert-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: #EF4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            animation: pulseBadge 1.5s ease-in-out infinite;
        }

        @keyframes pulseBadge {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 10px 5px rgba(239, 68, 68, 0.3);
            }
        }

        /* Email display on action screen */
        .info-email {
            font-size: 14px;
            color: #8B949E;
            margin-top: 5px;
        }

        .info-email-link {
            color: #D4AF37;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: color 0.2s ease;
        }

        .info-email-link:hover {
            color: #F4E5A1;
            text-decoration: underline;
        }

        .set-email-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 16px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 6px;
            color: #D4AF37;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .set-email-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        /* Actions screen back button */
        .actions-back-btn {
            background: rgba(139, 148, 158, 0.2);
            border: 1px solid rgba(139, 148, 158, 0.4);
            color: #C9D1D9;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            align-self: flex-start;
            margin-bottom: 15px;
        }

        .actions-back-btn:hover {
            background: rgba(139, 148, 158, 0.3);
        }

        /* Time Adjustment Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .adjustment-modal, .email-modal {
            background: linear-gradient(135deg, #1a1f2e 0%, #252b3d 100%);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        .email-modal {
            max-width: 450px;
        }

        .email-prompt {
            text-align: center;
            font-size: 18px;
            color: #C9D1D9;
            margin-bottom: 25px;
        }

        .email-input-section {
            margin-bottom: 20px;
        }

        .email-input-section label {
            display: block;
            font-size: 14px;
            color: #8B949E;
            margin-bottom: 8px;
        }

        .email-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            background: rgba(10, 15, 31, 0.6);
            color: #C9D1D9;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: #D4AF37;
        }

        .email-error {
            color: #EF4444;
            font-size: 12px;
            margin-top: 6px;
            min-height: 18px;
        }

        .email-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .email-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .email-btn.yes {
            background: linear-gradient(135deg, #D4AF37, #F4E5A1);
            color: #0a0f1f;
        }

        .email-btn.yes:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .email-btn.no {
            background: rgba(139, 148, 158, 0.3);
            color: #C9D1D9;
        }

        .email-btn.no:hover {
            background: rgba(139, 148, 158, 0.5);
        }

        .email-send-section {
            margin-top: 20px;
            text-align: center;
        }

        @keyframes modalSlide {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #D4AF37;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .modal-body {
            padding: 25px;
        }

        .status-card {
            background: rgba(30, 35, 45, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-size: 14px;
            color: #8B949E;
        }

        .status-value {
            font-size: 16px;
            font-weight: 600;
            color: #C9D1D9;
        }

        .status-value.clocked-in {
            color: #10B981;
        }

        .status-value.clocked-out {
            color: #8B949E;
        }

        .sessions-section {
            margin-bottom: 20px;
        }

        .sessions-title {
            font-size: 16px;
            font-weight: 600;
            color: #D4AF37;
            margin-bottom: 15px;
        }

        .session-card {
            background: rgba(30, 35, 45, 0.7);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(139, 148, 158, 0.2);
        }

        .session-times {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
        }

        .time-field {
            flex: 1;
        }

        .time-field label {
            display: block;
            font-size: 12px;
            color: #8B949E;
            margin-bottom: 6px;
        }

        .time-field input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(10, 15, 31, 0.6);
            color: #C9D1D9;
            font-size: 14px;
        }

        .time-field input:focus {
            outline: none;
            border-color: #D4AF37;
        }

        .session-duration {
            font-size: 13px;
            color: #8B949E;
        }

        .no-sessions {
            text-align: center;
            padding: 30px;
            color: #8B949E;
        }

        .add-session-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px dashed rgba(212, 175, 55, 0.4);
            background: transparent;
            color: #D4AF37;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .add-session-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.6);
        }

        .reason-field {
            margin-bottom: 20px;
        }

        .reason-field label {
            display: block;
            font-size: 14px;
            color: #C9D1D9;
            margin-bottom: 8px;
        }

        .reason-field textarea {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(10, 15, 31, 0.6);
            color: #C9D1D9;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .reason-field textarea:focus {
            outline: none;
            border-color: #D4AF37;
        }

        .disclaimer {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .disclaimer-title {
            font-size: 14px;
            font-weight: 600;
            color: #3B82F6;
            margin-bottom: 8px;
        }

        .disclaimer-text {
            font-size: 13px;
            color: #8B949E;
            line-height: 1.5;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .back-btn {
            position: absolute;
            top: 100px;
            left: 30px;
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid rgba(124, 58, 237, 0.4);
            color: #A78BFA;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(124, 58, 237, 0.3);
        }

        /* Clock Actions Screen */
        .actions-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 30px 40px;
            border-radius: 16px;
            border: none;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn.clock-in {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .action-btn.clock-in:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .action-btn.clock-out {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }

        .action-btn.clock-out:hover {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
        }

        .action-btn.adjustment {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
        }

        .action-btn.adjustment:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Info Panel */
        .info-panel {
            flex: 1;
            background: rgba(30, 35, 45, 0.7);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 16px;
            padding: 25px;
            display: flex;
            flex-direction: row;
            gap: 25px;
            overflow: hidden;
        }

        .info-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-notifications {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-left: 1px solid rgba(212, 175, 55, 0.15);
            padding-left: 20px;
        }

        .info-notifications-title {
            font-size: 14px;
            font-weight: 600;
            color: #D4AF37;
            margin-bottom: 5px;
        }

        .notification-item {
            background: rgba(10, 15, 31, 0.5);
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 13px;
            color: #C9D1D9;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notification-item.alert {
            border-left: 3px solid #EF4444;
        }

        .notification-item.pending {
            border-left: 3px solid #F59E0B;
        }

        .notification-item.approved {
            border-left: 3px solid #10B981;
        }

        .notification-item.denied {
            border-left: 3px solid #EF4444;
        }

        .notification-icon {
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
            line-height: 1.4;
        }

        .no-notifications {
            color: #8B949E;
            font-size: 13px;
            padding: 15px;
            text-align: center;
        }

        .info-user {
            display: flex;
            align-items: center;
            gap: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
        }

        .info-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D4AF37, #F4E5A1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: #0D1117;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
        }

        .info-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info-name {
            font-size: 28px;
            font-weight: 700;
            color: #C9D1D9;
        }

        .info-role {
            font-size: 14px;
            color: #8B949E;
        }

        .info-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: rgba(10, 15, 31, 0.5);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #D4AF37;
        }

        .stat-label {
            font-size: 12px;
            color: #8B949E;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }

        .last-punch {
            background: rgba(10, 15, 31, 0.5);
            border-radius: 12px;
            padding: 20px;
        }

        .last-punch-label {
            font-size: 12px;
            color: #8B949E;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .last-punch-value {
            font-size: 18px;
            font-weight: 600;
            color: #C9D1D9;
        }

        /* Success/Error Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .overlay.active {
            display: flex;
        }

        .overlay-content {
            text-align: center;
            padding: 60px;
            border-radius: 20px;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .overlay-content.success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        .overlay-content.error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }

        .overlay-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .overlay-message {
            font-size: 28px;
            font-weight: 700;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-top-color: #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .actions-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .action-btn {
                padding: 25px;
                font-size: 18px;
            }

            .info-panel {
                flex-direction: column;
            }

            .info-notifications {
                width: 100%;
                border-left: none;
                border-top: 1px solid rgba(212, 175, 55, 0.15);
                padding-left: 0;
                padding-top: 20px;
            }
        }

        @media (max-width: 600px) {
            .employee-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .employee-btn {
                padding: 20px 15px;
                min-height: 130px;
            }
            
            .employee-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .employee-name {
                font-size: 14px;
            }
            
            .numpad-btn {
                width: 70px;
                height: 70px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="kiosk-container">
        <header class="kiosk-header">
            <div class="kiosk-logo">
                <span class="kiosk-logo-icon">‚è∞</span>
                <span class="kiosk-logo-text">Time Warden</span>
            </div>
            <div>
                <div class="kiosk-time" id="currentTime">--:--</div>
                <div class="kiosk-date" id="currentDate">---</div>
            </div>
        </header>

        <!-- Screen 1: Employee Selection -->
        <div class="screen active" id="employeeScreen">
            <h2 style="font-size: 24px; color: #D4AF37; margin-bottom: 10px;">Select Your Name</h2>
            <div class="employee-grid" id="employeeGrid">
                <!-- Employees loaded dynamically -->
            </div>
        </div>

        <!-- Screen 2: PIN Entry -->
        <div class="screen pin-screen" id="pinScreen">
            <div class="pin-header">
                <div class="pin-title" id="pinTitle">Enter Your PIN</div>
                <div class="pin-subtitle" id="pinSubtitle">Enter your 4-digit PIN to continue</div>
            </div>
            <div class="pin-display">
                <div class="pin-dot" id="dot1"></div>
                <div class="pin-dot" id="dot2"></div>
                <div class="pin-dot" id="dot3"></div>
                <div class="pin-dot" id="dot4"></div>
            </div>
            <div class="pin-error" id="pinError"></div>
            <div class="numpad">
                <button class="numpad-btn" onclick="enterDigit('1')">1</button>
                <button class="numpad-btn" onclick="enterDigit('2')">2</button>
                <button class="numpad-btn" onclick="enterDigit('3')">3</button>
                <button class="numpad-btn" onclick="enterDigit('4')">4</button>
                <button class="numpad-btn" onclick="enterDigit('5')">5</button>
                <button class="numpad-btn" onclick="enterDigit('6')">6</button>
                <button class="numpad-btn" onclick="enterDigit('7')">7</button>
                <button class="numpad-btn" onclick="enterDigit('8')">8</button>
                <button class="numpad-btn" onclick="enterDigit('9')">9</button>
                <button class="numpad-btn special" onclick="clearPin()">Clear</button>
                <button class="numpad-btn" onclick="enterDigit('0')">0</button>
                <button class="numpad-btn special delete" onclick="deleteDigit()">‚å´</button>
            </div>
            <button class="forgot-pin-btn" onclick="showForgotPinModal()">Forgot PIN?</button>
        </div>

        <!-- Screen 3: Clock Actions -->
        <div class="screen" id="actionsScreen">
            <button class="actions-back-btn" onclick="backToEmployeeGrid()">‚Üê Back</button>
            <div class="actions-row">
                <button class="action-btn clock-in" id="clockInBtn" onclick="clockAction('in')">
                    <span>‚ñ∂</span> Clock In
                </button>
                <button class="action-btn clock-out" id="clockOutBtn" onclick="clockAction('out')">
                    <span>‚ñ†</span> Clock Out
                </button>
                <button class="action-btn adjustment" onclick="requestAdjustment()">
                    <span>üìù</span> Time Adjustment
                </button>
            </div>
            <div class="info-panel" id="infoPanel">
                <!-- Loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Success/Error Overlay -->
    <div class="overlay" id="messageOverlay">
        <div class="overlay-content" id="overlayContent">
            <div class="overlay-icon" id="overlayIcon"></div>
            <div class="overlay-message" id="overlayMessage"></div>
        </div>
    </div>

    <!-- Time Adjustment Modal -->
    <div class="modal-overlay" id="adjustmentModal">
        <div class="adjustment-modal">
            <div class="modal-header">
                <h2 class="modal-title">üìù Time Adjustment</h2>
                <button class="modal-close" onclick="closeAdjustmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Current Status Card -->
                <div class="status-card">
                    <div class="status-row">
                        <span class="status-label">Current Time</span>
                        <span class="status-value" id="modalCurrentTime">--:--</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Status</span>
                        <span class="status-value" id="modalStatus">Loading...</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Today's Hours</span>
                        <span class="status-value" id="modalTodayHours">--</span>
                    </div>
                </div>

                <!-- Today's Sessions -->
                <div class="sessions-section">
                    <div class="sessions-title">Today's Entries</div>
                    <div id="sessionsContainer">
                        <div class="no-sessions">Loading sessions...</div>
                    </div>
                </div>

                <!-- Add New Session Button -->
                <button class="add-session-btn" onclick="addNewSessionRow()">
                    + Add Missing Time Entry
                </button>

                <!-- Reason Field -->
                <div class="reason-field">
                    <label for="adjustmentReason">Reason for Adjustment</label>
                    <textarea id="adjustmentReason" placeholder="Please explain why you need this time adjustment..."></textarea>
                </div>

                <!-- Disclaimer -->
                <div class="disclaimer">
                    <div class="disclaimer-title">‚ö†Ô∏è Important Notice</div>
                    <div class="disclaimer-text">
                        Time adjustment requests are not guaranteed to be approved. Your administrator will review this request and may approve or deny it. You will see the status of your request reflected in your hours once reviewed.
                    </div>
                </div>

                <!-- Submit Button -->
                <button class="submit-btn" id="submitAdjustmentBtn" onclick="submitAdjustment()">
                    Submit Adjustment Request
                </button>
            </div>
        </div>
    </div>

    <!-- Email Receipt Modal -->
    <div class="modal-overlay" id="emailReceiptModal">
        <div class="email-modal">
            <div class="modal-header">
                <h2 class="modal-title">üìß Email Shift Summary?</h2>
                <button class="modal-close" onclick="closeEmailModal(false)">&times;</button>
            </div>
            <div class="modal-body">
                <div class="email-prompt">
                    <p>Would you like to receive an email summary of your shift?</p>
                </div>
                
                <div class="email-input-section" id="emailInputSection" style="display: none;">
                    <label for="shiftEmailInput">Email Address</label>
                    <input type="email" id="shiftEmailInput" class="email-input" placeholder="Enter your email address">
                    <div class="email-error" id="emailError"></div>
                </div>
                
                <div class="email-buttons">
                    <button class="email-btn yes" id="emailYesBtn" onclick="showEmailInput()">
                        Yes, Send Email
                    </button>
                    <button class="email-btn no" onclick="closeEmailModal(false)">
                        No Thanks
                    </button>
                </div>
                
                <div class="email-send-section" id="emailSendSection" style="display: none;">
                    <button class="submit-btn" onclick="sendShiftEmail()">
                        Send Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot PIN Modal -->
    <div class="modal-overlay" id="forgotPinModal">
        <div class="forgot-pin-modal">
            <div class="forgot-pin-icon">üîë</div>
            <div class="forgot-pin-title">Forgot Your PIN?</div>
            <div class="forgot-pin-text">
                Your administrator will be notified to help reset your PIN. Please speak with your manager.
            </div>
            <div class="forgot-pin-buttons">
                <button class="forgot-pin-confirm" onclick="confirmForgotPin()">
                    Notify Admin
                </button>
                <button class="forgot-pin-cancel" onclick="closeForgotPinModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Set Email Modal (for action screen) -->
    <div class="modal-overlay" id="setEmailModal">
        <div class="email-modal">
            <div class="modal-header">
                <h2 class="modal-title">üìß Set Your Email</h2>
                <button class="modal-close" onclick="closeSetEmailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="email-prompt">
                    <p>Enter your email address to receive shift summaries and notifications.</p>
                </div>
                
                <div class="email-input-section">
                    <label for="setEmailInput">Email Address</label>
                    <input type="email" id="setEmailInput" class="email-input" placeholder="Enter your email address">
                    <div class="email-error" id="setEmailError"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="submit-btn" onclick="saveEmployeeEmail()">
                        Save Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GUILD_ID = '{{ guild_id }}';
        let currentEmployee = null;
        let pinBuffer = '';
        let pinMode = 'verify'; // 'verify', 'create', 'confirm'
        let newPinBuffer = '';
        let inactivityTimer = null;
        const INACTIVITY_TIMEOUT = 10000; // 10 seconds

        // Inactivity timeout - returns to employee selection after 10 seconds
        function resetInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            // Only set timer if not on employee selection screen
            if (currentEmployee !== null) {
                inactivityTimer = setTimeout(() => {
                    logout();
                }, INACTIVITY_TIMEOUT);
            }
        }

        // Reset timer on any user interaction
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('touchstart', resetInactivityTimer);

        // Update clock
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Kiosk customization setting
        let allowKioskCustomization = false;

        // Load employees
        async function loadEmployees() {
            showLoading(true);
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/employees`);
                const data = await response.json();
                
                if (data.success) {
                    allowKioskCustomization = data.allow_kiosk_customization || false;
                    renderEmployees(data.employees);
                } else {
                    showMessage('error', data.error || 'Failed to load employees');
                }
            } catch (error) {
                console.error('Failed to load employees:', error);
                showMessage('error', 'Connection error');
            }
            showLoading(false);
        }

        function renderEmployees(employees) {
            const grid = document.getElementById('employeeGrid');
            grid.innerHTML = employees.map(emp => {
                const accentClass = allowKioskCustomization ? `accent-${emp.accent_color || 'cyan'}` : '';
                return `
                <button class="employee-btn ${emp.is_clocked_in ? 'clocked-in' : ''} ${accentClass}" onclick="selectEmployee(${JSON.stringify(emp).replace(/"/g, '&quot;')})">
                    ${emp.has_alerts ? '<div class="email-alert-badge">!</div>' : ''}
                    <div class="employee-avatar">
                        ${emp.avatar_url ? `<img src="${emp.avatar_url}" alt="${emp.display_name}">` : emp.display_name.charAt(0).toUpperCase()}
                    </div>
                    <div class="employee-name">${escapeHtml(emp.display_name)}</div>
                    <div class="employee-status ${emp.is_clocked_in ? 'in' : 'out'}">
                        ${emp.is_clocked_in ? 'Clocked In' : 'Clocked Out'}
                    </div>
                </button>
            `;
            }).join('');
        }

        function selectEmployee(employee) {
            currentEmployee = employee;
            pinBuffer = '';
            updatePinDots();
            document.getElementById('pinError').textContent = '';
            resetInactivityTimer(); // Start inactivity timer
            
            if (employee.has_pin) {
                pinMode = 'verify';
                document.getElementById('pinTitle').textContent = `Welcome, ${employee.display_name}`;
                document.getElementById('pinSubtitle').textContent = 'Enter your 4-digit PIN';
            } else {
                pinMode = 'create';
                document.getElementById('pinTitle').textContent = 'Create Your PIN';
                document.getElementById('pinSubtitle').textContent = 'Choose a 4-digit PIN you will remember';
            }
            
            showScreen('pin');
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + 'Screen').classList.add('active');
        }

        function enterDigit(digit) {
            if (pinBuffer.length < 4) {
                pinBuffer += digit;
                updatePinDots();
                
                if (pinBuffer.length === 4) {
                    setTimeout(handlePinComplete, 200);
                }
            }
        }

        function deleteDigit() {
            pinBuffer = pinBuffer.slice(0, -1);
            updatePinDots();
            document.getElementById('pinError').textContent = '';
        }

        function clearPin() {
            pinBuffer = '';
            updatePinDots();
            document.getElementById('pinError').textContent = '';
        }

        function updatePinDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById('dot' + i);
                dot.classList.toggle('filled', i <= pinBuffer.length);
            }
        }

        async function handlePinComplete() {
            if (pinMode === 'create') {
                newPinBuffer = pinBuffer;
                pinBuffer = '';
                pinMode = 'confirm';
                document.getElementById('pinTitle').textContent = 'Confirm Your PIN';
                document.getElementById('pinSubtitle').textContent = 'Enter the same PIN again';
                updatePinDots();
            } else if (pinMode === 'confirm') {
                if (pinBuffer === newPinBuffer) {
                    await createPin(pinBuffer);
                } else {
                    document.getElementById('pinError').textContent = 'PINs do not match. Try again.';
                    pinBuffer = '';
                    pinMode = 'create';
                    document.getElementById('pinTitle').textContent = 'Create Your PIN';
                    document.getElementById('pinSubtitle').textContent = 'Choose a 4-digit PIN you will remember';
                    updatePinDots();
                }
            } else {
                await verifyPin(pinBuffer);
            }
        }

        async function createPin(pin) {
            showLoading(true);
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/pin/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentEmployee.user_id,
                        pin: pin
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showActionsScreen();
                } else {
                    document.getElementById('pinError').textContent = data.error || 'Failed to create PIN';
                    clearPin();
                }
            } catch (error) {
                document.getElementById('pinError').textContent = 'Connection error';
                clearPin();
            }
            showLoading(false);
        }

        async function verifyPin(pin) {
            showLoading(true);
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/pin/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentEmployee.user_id,
                        pin: pin
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showActionsScreen();
                } else {
                    document.getElementById('pinError').textContent = data.error || 'Incorrect PIN';
                    clearPin();
                }
            } catch (error) {
                document.getElementById('pinError').textContent = 'Connection error';
                clearPin();
            }
            showLoading(false);
        }

        async function showActionsScreen() {
            showLoading(true);
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/employee/${currentEmployee.user_id}/info`);
                const data = await response.json();
                
                if (data.success) {
                    renderInfoPanel(data);
                    updateActionButtons(data.is_clocked_in);
                }
            } catch (error) {
                console.error('Failed to load employee info:', error);
            }
            showLoading(false);
            showScreen('actions');
        }

        let currentEmployeeEmail = null;

        function renderInfoPanel(data) {
            const panel = document.getElementById('infoPanel');
            currentEmployeeEmail = data.email || null;
            
            // Email display: show email with update link, or set email button
            const emailDisplay = data.email 
                ? `<div class="info-email">üìß ${escapeHtml(data.email)} <span class="info-email-link" onclick="openSetEmailModal()">Update</span></div>`
                : `<button class="set-email-btn" onclick="openSetEmailModal()">üìß Set Email Address</button>`;
            
            // Build notifications HTML
            let notificationsHtml = '';
            const notifications = data.notifications || [];
            
            if (notifications.length > 0) {
                notificationsHtml = notifications.map(n => `
                    <div class="notification-item ${n.type}">
                        <span class="notification-icon">${n.icon}</span>
                        <span class="notification-text">${escapeHtml(n.text)}</span>
                    </div>
                `).join('');
            } else {
                notificationsHtml = '<div class="no-notifications">No notifications</div>';
            }
            
            panel.innerHTML = `
                <div class="info-main">
                    <div class="info-user">
                        <div class="info-avatar">
                            ${data.avatar_url ? `<img src="${data.avatar_url}" alt="">` : currentEmployee.display_name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="info-name">${escapeHtml(currentEmployee.display_name)}</div>
                            <div class="info-role">${escapeHtml(data.position || 'Team Member')}</div>
                            ${emailDisplay}
                        </div>
                    </div>
                    <div class="info-stats">
                        <div class="stat-card">
                            <div class="stat-value">${formatDuration(data.week_hours)}</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatDuration(data.today_hours)}</div>
                            <div class="stat-label">Today</div>
                        </div>
                    </div>
                    <div class="last-punch">
                        <div class="last-punch-label">Last Punch</div>
                        <div class="last-punch-value">${data.last_punch || 'No recent activity'}</div>
                    </div>
                </div>
                <div class="info-notifications">
                    <div class="info-notifications-title">Notifications</div>
                    ${notificationsHtml}
                </div>
            `;
        }

        function updateActionButtons(isClockedIn) {
            const inBtn = document.getElementById('clockInBtn');
            const outBtn = document.getElementById('clockOutBtn');
            
            if (isClockedIn) {
                inBtn.style.display = 'none';
                outBtn.style.display = 'block';
                inBtn.disabled = true;
                outBtn.disabled = false;
            } else {
                inBtn.style.display = 'block';
                outBtn.style.display = 'none';
                inBtn.disabled = false;
                outBtn.disabled = true;
            }
        }

        let lastClockOutSessionId = null;
        let savedEmployeeEmail = null;

        async function clockAction(action) {
            showLoading(true);
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/clock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentEmployee.user_id,
                        action: action
                    })
                });
                
                const data = await response.json();
                showLoading(false);
                
                if (data.success) {
                    // Update current employee state immediately
                    if (currentEmployee) {
                        currentEmployee.is_clocked_in = (action === 'in');
                    }
                    
                    // Update UI buttons immediately
                    updateActionButtons(action === 'in');
                    
                    // Refresh info panel for latest stats (always do this)
                    try {
                        const infoResponse = await fetch(`/api/kiosk/${GUILD_ID}/employee/${currentEmployee.user_id}/info`);
                        const infoData = await infoResponse.json();
                        if (infoData.success) {
                            renderInfoPanel(infoData);
                        }
                    } catch (infoErr) {
                        console.error('Failed to refresh info panel:', infoErr);
                    }
                    
                    if (action === 'in') {
                        showMessage('success', 'Clocked In Successfully!');
                        // Auto-logout after 3 seconds for clock-in
                        setTimeout(() => {
                            logout();
                        }, 3000);
                    } else {
                        // For clock-out, save session ID and show email modal
                        lastClockOutSessionId = data.session_id || null;
                        showEmailReceiptModal();
                    }
                } else {
                    showMessage('error', data.error || 'Failed to ' + action);
                }
            } catch (error) {
                showLoading(false);
                showMessage('error', 'Connection error');
            }
        }

        async function showEmailReceiptModal() {
            const modal = document.getElementById('emailReceiptModal');
            const emailInput = document.getElementById('shiftEmailInput');
            const inputSection = document.getElementById('emailInputSection');
            const sendSection = document.getElementById('emailSendSection');
            const buttonsSection = document.querySelector('.email-buttons');
            const promptEl = modal.querySelector('.email-prompt');
            const yesBtn = modal.querySelector('.email-btn.yes');
            
            // Reset modal state
            inputSection.style.display = 'none';
            sendSection.style.display = 'none';
            buttonsSection.style.display = 'flex';
            document.getElementById('emailError').textContent = '';
            
            // Try to fetch saved email for auto-population
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/employee/${currentEmployee.user_id}/email`);
                const data = await response.json();
                if (data.success && data.email) {
                    savedEmployeeEmail = data.email;
                    emailInput.value = data.email;
                    // Update modal to show "Send to <email>?" instead of asking to enter email
                    promptEl.innerHTML = `Send shift summary to<br><strong>${escapeHtml(data.email)}</strong>?`;
                    yesBtn.textContent = 'Send';
                    yesBtn.onclick = function() { sendShiftEmail(); };
                } else {
                    savedEmployeeEmail = null;
                    emailInput.value = '';
                    promptEl.innerHTML = 'Would you like a shift summary sent to your email?';
                    yesBtn.textContent = 'Yes';
                    yesBtn.onclick = function() { showEmailInput(); };
                }
            } catch (error) {
                console.error('Failed to fetch employee email:', error);
                emailInput.value = '';
                promptEl.innerHTML = 'Would you like a shift summary sent to your email?';
                yesBtn.textContent = 'Yes';
                yesBtn.onclick = function() { showEmailInput(); };
            }
            
            modal.classList.add('active');
            resetInactivityTimer();
        }

        function showEmailInput() {
            const inputSection = document.getElementById('emailInputSection');
            const sendSection = document.getElementById('emailSendSection');
            const buttonsSection = document.querySelector('.email-buttons');
            
            inputSection.style.display = 'block';
            sendSection.style.display = 'block';
            buttonsSection.style.display = 'none';
            
            document.getElementById('shiftEmailInput').focus();
            resetInactivityTimer();
        }

        async function sendShiftEmail() {
            const emailInput = document.getElementById('shiftEmailInput');
            const email = emailInput.value.trim();
            const errorEl = document.getElementById('emailError');
            
            // Validate email
            if (!email) {
                errorEl.textContent = 'Please enter an email address';
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Please enter a valid email address';
                return;
            }
            
            errorEl.textContent = '';
            showLoading(true);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch(`/api/kiosk/${GUILD_ID}/send-shift-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentEmployee.user_id,
                        email: email,
                        session_id: lastClockOutSessionId
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                let data;
                try {
                    data = await response.json();
                } catch (parseErr) {
                    showLoading(false);
                    errorEl.textContent = `Server error (${response.status}). Try again.`;
                    return;
                }
                
                showLoading(false);
                
                if (data.success) {
                    closeEmailModal(true);
                    showMessage('success', 'Shift summary sent to your email!');
                    setTimeout(() => { logout(); }, 3000);
                } else {
                    errorEl.textContent = data.error || 'Failed to send email';
                }
            } catch (error) {
                showLoading(false);
                if (error.name === 'AbortError') {
                    errorEl.textContent = 'Request timed out. Try again.';
                } else {
                    errorEl.textContent = 'Connection error. Try again.';
                    console.error('Shift email error:', error);
                }
            }
        }

        function closeEmailModal(emailSent) {
            document.getElementById('emailReceiptModal').classList.remove('active');
            
            if (!emailSent) {
                // User declined email, just show clock-out success and logout
                showMessage('success', 'Clocked Out Successfully!');
                setTimeout(() => { logout(); }, 3000);
            }
            resetInactivityTimer();
        }

        let todaySessions = [];
        let pendingChanges = [];
        let nextTempId = 1;

        function requestAdjustment() {
            if (!currentEmployee) {
                showMessage('error', 'Please select an employee first');
                return;
            }
            openAdjustmentModal();
        }

        async function openAdjustmentModal() {
            const modal = document.getElementById('adjustmentModal');
            modal.classList.add('active');
            
            // Update current time in modal
            updateModalTime();
            
            // Load today's sessions
            await loadTodaySessions();
        }

        function closeAdjustmentModal() {
            document.getElementById('adjustmentModal').classList.remove('active');
            document.getElementById('adjustmentReason').value = '';
            pendingChanges = [];
            resetInactivityTimer();
        }

        function updateModalTime() {
            const now = new Date();
            document.getElementById('modalCurrentTime').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        async function loadTodaySessions() {
            if (!currentEmployee) return;
            
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/employee/${currentEmployee.user_id}/today-sessions`);
                const data = await response.json();
                
                if (data.success) {
                    todaySessions = data.sessions;
                    
                    // Update status
                    const statusEl = document.getElementById('modalStatus');
                    if (data.is_clocked_in) {
                        statusEl.textContent = 'Clocked In';
                        statusEl.className = 'status-value clocked-in';
                    } else {
                        statusEl.textContent = 'Clocked Out';
                        statusEl.className = 'status-value clocked-out';
                    }
                    
                    // Update today's hours
                    const hours = Math.floor(data.today_total_minutes / 60);
                    const mins = data.today_total_minutes % 60;
                    document.getElementById('modalTodayHours').textContent = 
                        hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                    
                    renderSessions();
                } else {
                    document.getElementById('sessionsContainer').innerHTML = 
                        '<div class="no-sessions">Error loading sessions</div>';
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessionsContainer').innerHTML = 
                    '<div class="no-sessions">Error loading sessions</div>';
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessionsContainer');
            
            if (todaySessions.length === 0) {
                container.innerHTML = '<div class="no-sessions">No time entries for today</div>';
                return;
            }
            
            let html = '';
            todaySessions.forEach((session, index) => {
                const isActive = session.is_active;
                const durationText = isActive ? 'Active' : `${session.duration_minutes}m`;
                
                html += `
                    <div class="session-card" data-session-id="${session.session_id}" data-index="${index}">
                        <div class="session-times">
                            <div class="time-field">
                                <label>Clock In</label>
                                <input type="time" value="${session.clock_in || ''}" 
                                       data-field="clock_in"
                                       data-original="${session.clock_in || ''}"
                                       onchange="markSessionChanged(${index}, 'clock_in', this.value)">
                            </div>
                            <div class="time-field">
                                <label>Clock Out</label>
                                <input type="time" value="${session.clock_out || ''}" 
                                       data-field="clock_out"
                                       data-original="${session.clock_out || ''}"
                                       ${isActive ? 'placeholder="Still working..."' : ''}
                                       onchange="markSessionChanged(${index}, 'clock_out', this.value)">
                            </div>
                        </div>
                        <div class="session-duration">Duration: ${durationText}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function markSessionChanged(index, field, newValue) {
            const session = todaySessions[index];
            
            // Get the card using data-index for precise selection
            const card = document.querySelector(`.session-card[data-index="${index}"]`);
            const clockInInput = card.querySelector('input[data-field="clock_in"]');
            const clockOutInput = card.querySelector('input[data-field="clock_out"]');
            
            const currentClockIn = clockInInput.value;
            const currentClockOut = clockOutInput.value;
            
            // Check if either field differs from original
            const clockInChanged = currentClockIn !== (session.clock_in || '');
            const clockOutChanged = currentClockOut !== (session.clock_out || '');
            
            // Find existing change for this session
            const existingIdx = pendingChanges.findIndex(c => 
                c.session_id === session.session_id && !c.is_new
            );
            
            if (clockInChanged || clockOutChanged) {
                // Build change object with current input values
                const change = {
                    session_id: session.session_id,
                    is_new: false
                };
                
                if (clockInChanged) {
                    change.new_clock_in = currentClockIn;
                }
                if (clockOutChanged) {
                    change.new_clock_out = currentClockOut;
                }
                
                if (existingIdx >= 0) {
                    // Update existing change
                    pendingChanges[existingIdx] = change;
                } else {
                    // Add new change
                    pendingChanges.push(change);
                }
            } else {
                // No changes from original - remove from pending if exists
                if (existingIdx >= 0) {
                    pendingChanges.splice(existingIdx, 1);
                }
            }
            
            resetInactivityTimer();
        }

        function addNewSessionRow() {
            const container = document.getElementById('sessionsContainer');
            const tempId = `new_${nextTempId++}`;
            
            // Remove "no sessions" message if present
            const noSessions = container.querySelector('.no-sessions');
            if (noSessions) {
                noSessions.remove();
            }
            
            const newCard = document.createElement('div');
            newCard.className = 'session-card';
            newCard.dataset.tempId = tempId;
            newCard.innerHTML = `
                <div class="session-times">
                    <div class="time-field">
                        <label>Clock In</label>
                        <input type="time" id="new_in_${tempId}" placeholder="--:--">
                    </div>
                    <div class="time-field">
                        <label>Clock Out</label>
                        <input type="time" id="new_out_${tempId}" placeholder="--:--">
                    </div>
                </div>
                <div class="session-duration" style="color: #3B82F6;">New Entry - Not yet saved</div>
            `;
            
            container.appendChild(newCard);
            
            // Track this new session in pending changes
            pendingChanges.push({
                temp_id: tempId,
                is_new: true,
                new_clock_in: null,
                new_clock_out: null
            });
            
            resetInactivityTimer();
        }

        async function submitAdjustment() {
            const reason = document.getElementById('adjustmentReason').value.trim();
            
            if (!reason) {
                showMessage('error', 'Please provide a reason for the adjustment');
                return;
            }
            
            // Collect all changes including new sessions
            const changes = [];
            
            // Get modified existing sessions
            pendingChanges.forEach(change => {
                if (change.is_new) {
                    // Get values from new session inputs
                    const inInput = document.getElementById(`new_in_${change.temp_id}`);
                    const outInput = document.getElementById(`new_out_${change.temp_id}`);
                    
                    if (inInput && outInput && inInput.value && outInput.value) {
                        changes.push({
                            is_new: true,
                            new_clock_in: inInput.value,
                            new_clock_out: outInput.value
                        });
                    }
                } else {
                    changes.push(change);
                }
            });
            
            if (changes.length === 0) {
                showMessage('error', 'No changes to submit');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/adjustment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentEmployee.user_id,
                        reason: reason,
                        changes: changes
                    })
                });
                
                const data = await response.json();
                
                showLoading(false);
                
                if (data.success) {
                    closeAdjustmentModal();
                    showMessage('success', 'Adjustment request submitted! Your admin will review it.');
                    setTimeout(() => {
                        logout();
                    }, 3000);
                } else {
                    showMessage('error', data.error || 'Failed to submit adjustment');
                }
            } catch (error) {
                showLoading(false);
                showMessage('error', 'Connection error. Please try again.');
            }
        }

        // Forgot PIN Modal Functions
        function showForgotPinModal() {
            if (!currentEmployee) return;
            document.getElementById('forgotPinModal').classList.add('active');
            resetInactivityTimer();
        }

        function closeForgotPinModal() {
            document.getElementById('forgotPinModal').classList.remove('active');
            resetInactivityTimer();
        }

        async function confirmForgotPin() {
            if (!currentEmployee) return;
            
            showLoading(true);
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/forgot-pin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentEmployee.user_id,
                        display_name: currentEmployee.display_name
                    })
                });
                
                const data = await response.json();
                showLoading(false);
                closeForgotPinModal();
                
                if (data.success) {
                    showMessage('success', 'Admin has been notified. Please speak with your manager.');
                } else {
                    showMessage('error', data.error || 'Failed to send notification');
                }
                
                // Return to employee grid after showing message
                setTimeout(() => {
                    logout();
                }, 2500);
            } catch (error) {
                showLoading(false);
                closeForgotPinModal();
                showMessage('error', 'Connection error');
                setTimeout(() => {
                    logout();
                }, 2500);
            }
        }

        // Set Email Modal Functions
        function openSetEmailModal() {
            const modal = document.getElementById('setEmailModal');
            const input = document.getElementById('setEmailInput');
            const errorEl = document.getElementById('setEmailError');
            
            // Pre-populate with current email if exists
            input.value = currentEmployeeEmail || '';
            errorEl.textContent = '';
            
            modal.classList.add('active');
            input.focus();
            
            // Clear timer so it doesn't close while typing
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }

        function closeSetEmailModal() {
            const modal = document.getElementById('setEmailModal');
            modal.classList.remove('active');
            resetInactivityTimer();
        }

        async function saveEmployeeEmail() {
            const input = document.getElementById('setEmailInput');
            const errorEl = document.getElementById('setEmailError');
            const email = input.value.trim();
            
            // Validate email
            if (!email) {
                errorEl.textContent = 'Please enter an email address';
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Please enter a valid email address';
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`/api/kiosk/${GUILD_ID}/employee/${currentEmployee.user_id}/email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                showLoading(false);
                
                if (data.success) {
                    currentEmployeeEmail = email;
                    closeSetEmailModal();
                    showMessage('success', 'Email saved successfully!');
                    
                    // Refresh info panel to show updated email
                    try {
                        const infoResponse = await fetch(`/api/kiosk/${GUILD_ID}/employee/${currentEmployee.user_id}/info`);
                        const infoData = await infoResponse.json();
                        if (infoData.success) {
                            renderInfoPanel(infoData);
                        }
                    } catch (err) {
                        console.error('Failed to refresh info panel:', err);
                    }
                } else {
                    errorEl.textContent = data.error || 'Failed to save email';
                }
            } catch (error) {
                showLoading(false);
                errorEl.textContent = 'Connection error. Please try again.';
            }
        }

        // Back button to return to employee grid
        function backToEmployeeGrid() {
            logout();
        }

        // History state management to prevent browser back from exiting kiosk
        function initializeHistoryState() {
            // Push initial state to prevent exiting kiosk with back button
            history.pushState({ screen: 'employee' }, '', window.location.href);
        }

        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            // Always push state back and stay in kiosk
            history.pushState({ screen: 'kiosk' }, '', window.location.href);
            
            // If we're on PIN or actions screen, go back to employee grid
            const employeeScreen = document.getElementById('employeeScreen');
            if (!employeeScreen.classList.contains('active')) {
                logout();
            }
        });

        function logout() {
            // Clear inactivity timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
            currentEmployee = null;
            pinBuffer = '';
            pinMode = 'verify';
            currentEmployeeEmail = null;
            loadEmployees();
            showScreen('employee');
            
            // Re-push history state to maintain kiosk lock
            history.pushState({ screen: 'employee' }, '', window.location.href);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showMessage(type, message) {
            const overlay = document.getElementById('messageOverlay');
            const content = document.getElementById('overlayContent');
            const icon = document.getElementById('overlayIcon');
            const msg = document.getElementById('overlayMessage');
            
            content.className = 'overlay-content ' + type;
            icon.textContent = type === 'success' ? '‚úì' : '‚úï';
            msg.textContent = message;
            
            overlay.classList.add('active');
            
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 2500);
        }

        function formatDuration(minutes) {
            if (!minutes && minutes !== 0) return '--';
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        initializeHistoryState();
        loadEmployees();
    </script>
</body>
</html>
