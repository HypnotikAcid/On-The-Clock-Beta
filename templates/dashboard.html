<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - On the Clock</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>

<body>
    <!-- Matrix Canvas Background -->
    <canvas id="matrix-canvas"></canvas>

    <!-- Sidebar is now OUTSIDE layout-container for proper z-index stacking -->
    <aside class="sidebar" id="sidebar">
        <!-- Logo -->
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">⚙️</span>
            <div class="sidebar-logo-text">On the Clock<br>Dashboard</div>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav">
            <!-- Main Navigation (shown when no server is selected) -->
            <div id="main-nav">
                <div class="nav-section-title">Navigation</div>
                <div class="nav-item active" data-section="my-servers">
                    <span class="nav-item-icon">🏢</span>
                    <span>My Servers</span>
                </div>
            </div>

            <!-- Server-Specific Navigation (hidden by default) -->
            <div id="server-nav" style="display: none;">
                <div class="back-to-servers" id="backToServers">
                    <span>&larr;</span>
                    <span>Back to Servers</span>
                </div>
                <div class="server-nav-header" id="serverNavHeader">
                    <div class="server-nav-icon" id="serverNavIcon">S</div>
                    <div class="server-nav-name" id="serverNavName">Server Name</div>
                </div>
                <div class="nav-section-title">Server Settings</div>
                <div class="nav-item" data-section="server-overview" data-server-menu>
                    <span class="nav-item-icon">📊</span>
                    <span>Server Overview</span>
                </div>
                <div class="nav-item admin-only" data-section="admin-roles" data-server-menu>
                    <span class="nav-item-icon">👥</span>
                    <span>Admin Roles</span>
                </div>
                <div class="nav-item admin-only" data-section="employee-roles" data-server-menu>
                    <span class="nav-item-icon">👷</span>
                    <span>Employee Roles</span>
                </div>
                <div class="nav-item admin-only" data-section="email-settings" data-server-menu>
                    <span class="nav-item-icon">📧</span>
                    <span>Email Settings</span>
                </div>
                <div class="nav-item admin-only" data-section="timezone-settings" data-server-menu>
                    <span class="nav-item-icon">&#9200;</span>
                    <span>Timezone Settings</span>
                    <span class="badge tz-reminder" id="tz-reminder-badge"
                        style="display:none; background:#F59E0B; color:#111; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; margin-left:auto;">Set
                        TZ!</span>
                </div>
                <div class="nav-item admin-only" data-section="employees" data-server-menu>
                    <span class="nav-item-icon">👥</span>
                    <span>Employee Status</span>
                </div>
                <div class="nav-item employee-only" data-section="on-the-clock" data-server-menu>
                    <span class="nav-item-icon">⏰</span>
                    <span>On the Clock</span>
                </div>
                <div class="nav-item" data-section="adjustments" data-server-menu>
                    <span class="nav-item-icon">⏳</span>
                    <span>Time Adjustments</span>
                    <span class="badge" id="pending-count"
                        style="display:none; background: #EF4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: auto;">0</span>
                </div>
                <div class="nav-item admin-only" data-section="admin-calendar" data-server-menu>
                    <span class="nav-item-icon">📅</span>
                    <span>Admin Calendar</span>
                </div>
                <div class="nav-item admin-only" data-section="ban-management" data-server-menu>
                    <span class="nav-item-icon">🚫</span>
                    <span>Ban Management</span>
                </div>
                <div class="nav-item" data-section="beta-settings" data-server-menu>
                    <span class="nav-item-icon">🧪</span>
                    <span>Beta Settings</span>
                </div>
            </div>
        </nav>

        <!-- User Profile -->
        <div class="sidebar-user">
            <div class="sidebar-user-avatar">
                {% if user.avatar %}
                <img src="https://cdn.discordapp.com/avatars/{{ user.user_id }}/{{ user.avatar }}.png?size=128"
                    alt="Avatar">
                {% else %}
                {{ user.username[0]|upper }}
                {% endif %}
            </div>
            <div class="sidebar-user-info">
                <div class="sidebar-user-name">{{ user.username }}</div>
                <div class="sidebar-user-id">{{ user.user_id[:8] }}...</div>
            </div>
            <a href="/auth/logout" class="logout-icon" title="Logout">🚪</a>
        </div>
    </aside>

    <!-- Mobile overlay - catches taps to close sidebar -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Main Layout -->
    <div class="layout-container">
        <!-- Right Content Area -->
        <main class="content-area">
            <!-- Admin/Employee View Mode Toggle -->
            <div id="view-mode-toggle" class="view-mode-toggle" style="display: none;">
                <span class="view-mode-label">View as:</span>
                <div class="view-mode-switch">
                    <button class="view-mode-btn active" data-mode="admin">Admin</button>
                    <button class="view-mode-btn" data-mode="employee">Employee</button>
                </div>
            </div>

            <!-- My Servers Section -->
            <section class="content-section active" id="section-my-servers">
                <div class="content-header">
                    <h1 class="content-title">My Servers</h1>
                    <p class="content-subtitle">Your managed servers and workplaces</p>
                </div>

                {% if not user.admin_guilds and not user.employee_guilds %}
                <div class="tiles-grid">
                    <div class="tile">
                        <div class="empty-state" style="text-align: center; padding: 40px 20px; color: #8B949E;">
                            <div style="font-size: 48px; margin-bottom: 15px;">🏢</div>
                            <p style="margin-bottom: 10px; font-size: 16px;"><strong>No servers found</strong></p>
                            <p style="font-size: 13px; margin-bottom: 8px;">You don't have access to any servers yet.</p>
                            <p style="font-size: 13px; margin-bottom: 15px;">Either:</p>
                            <p style="font-size: 13px;">✅ Add the "On the Clock" bot to your server (as admin)</p>
                            <p style="font-size: 13px;">✅ Or get added as an employee in a server with the bot</p>
                            <p style="margin-top: 20px;"><a href="/invite" style="color: #D4AF37;">Add bot to your server</a></p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="tiles-grid">
                    <!-- Managed Servers Tile (Admin) -->
                    <div class="tile" id="managed-servers-tile">
                        <h2><span class="tile-icon">🏢</span>Managed Servers ({{ user.admin_guilds|length }})</h2>
                        <p style="color: #8B949E; font-size: 13px; margin-bottom: 15px;">
                            Servers where you have admin access
                        </p>
                        {% if user.admin_guilds %}
                        <div class="servers-list">
                            {% for guild in user.admin_guilds %}
                            <div class="server-item" data-guild-id="{{ guild.id }}" data-guild-name="{{ guild.name }}"
                                data-guild-icon="{% if guild.icon %}https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png?size=64{% endif %}"
                                data-access-level="admin">
                                <div class="server-icon">
                                    {% if guild.icon %}
                                    <img src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png?size=64"
                                        alt="{{ guild.name }}">
                                    {% else %}
                                    {{ guild.name[0]|upper }}
                                    {% endif %}
                                </div>
                                <div class="server-info">
                                    <div class="server-name">{{ guild.name }}</div>
                                    <div class="server-meta">
                                        {% if guild.bot_access_paid %}
                                        <span class="server-badge"
                                            style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15)); border: 1px solid rgba(16, 185, 129, 0.3); color: #10B981;">💰
                                            Paid</span>
                                        {% endif %}
                                        {% if guild.owner %}
                                        <span class="server-badge owner-badge">👑 Owner</span>
                                        {% elif guild.permissions|has_permission(0x8) %}
                                        <span class="server-badge admin-badge">⚡ Administrator</span>
                                        {% elif guild.permissions|has_permission(0x20) %}
                                        <span class="server-badge admin-badge">🔧 Manage Server</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state" style="text-align: center; padding: 20px; color: #8B949E;">
                            <p>No servers where you have admin access.</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- My Workplaces Tile (Employee) -->
                    <div class="tile" id="workplaces-tile">
                        <h2><span class="tile-icon">⏰</span>My Workplaces ({{ user.employee_guilds|length }})</h2>
                        <p style="color: #8B949E; font-size: 13px; margin-bottom: 15px;">
                            Servers where you clock in/out as an employee
                        </p>
                        {% if user.employee_guilds %}
                        <div class="servers-list">
                            {% for guild in user.employee_guilds %}
                            <div class="server-item" data-guild-id="{{ guild.id }}" data-guild-name="{{ guild.name }}"
                                data-guild-icon=""
                                data-access-level="employee">
                                <div class="server-icon">
                                    {{ guild.name[0]|upper }}
                                </div>
                                <div class="server-info">
                                    <div class="server-name">{{ guild.name }}</div>
                                    <div class="server-meta">
                                        <span class="server-badge" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15)); border: 1px solid rgba(59, 130, 246, 0.3); color: #3B82F6;">👷 Employee</span>
                                        <button onclick="event.stopPropagation(); DashboardTour.reset('employee')" class="reset-tour-mini" title="Reset Employee Tour" style="background:none; border:none; color:#8B949E; cursor:pointer; font-size:10px; padding:0 5px;">🔄 Reset Tour</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state" style="text-align: center; padding: 20px; color: #8B949E;">
                            <p>You haven't been added as an employee to any servers yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Server Overview Section -->
            <section class="content-section" id="section-server-overview">
                <div class="content-header">
                    <h1 class="content-title">Server Overview</h1>
                    <p class="content-subtitle" id="serverOverviewSubtitle">Server settings and configuration</p>
                </div>

                <!-- Sync Notice -->
                <div class="sync-notice">
                    <div class="sync-notice-icon">⏳</div>
                    <div class="sync-notice-text">
                        <strong>Sync Notice:</strong> Changes may take up to 10 seconds to sync with Discord commands.
                        Refresh this page to see the latest updates.
                    </div>
                </div>

                <div class="tiles-grid">
                    <div class="tile">
                        <h2><span class="tile-icon">📊</span>Server Information</h2>
                        <p class="tile-description">Quick overview of your server configuration and active settings.</p>
                        <p style="color: #C9D1D9; margin-top: 15px;">Select a setting from the sidebar to manage your
                            server.</p>
                    </div>
                                      <!-- Pending Time Adjustments Tile (Admin Only) -->
                                      <div class="tile clickable admin-only" id="pending-adjustments-tile" 
                         onclick="window.location.href='/server/' + document.getElementById('guild-selector').value + '/adjustments/review'"                         style="cursor: pointer;">
                        <h2>
                            <span class="tile-icon">⏳</span>
                            Pending Time Adjustments
                            <span id="pending-adjustments-badge" class="count-badge" style="display: none;">0</span>
                        </h2>
                        <p style="color: #8B949E; font-size: 13px; margin-bottom: 15px;">
                            Review and manage employee time adjustment requests
                        </p>
                        <div id="pending-adjustments-summary" style="margin-top: 15px;">
                            <div style="text-align: center; color: #8B949E; padding: 10px;">
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    // Load pending adjustments count on server overview page
                    (function() {
                        const guildSelector = document.getElementById('guild-selector');
                        const guildId = guildSelector ? guildSelector.value : null;
                        if (!guildId) return;
                        
                        fetch(`/api/guild/${guildId}/adjustments/pending`)
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    const count = (data.requests || []).length;
                                    const badge = document.getElementById('pending-adjustments-badge');
                                    const summary = document.getElementById('pending-adjustments-summary');
                                    
                                    if (count > 0) {
                                        badge.textContent = count;
                                        badge.style.display = 'inline-block';
                                        summary.innerHTML = `
                                            <div style="text-align: center;">
                                                <div style="color: #F59E0B; font-size: 32px; font-weight: 600; margin-bottom: 5px;">${count}</div>
                                                <div style="color: #8B949E; font-size: 12px;">request${count !== 1 ? 's' : ''} awaiting review</div>
                                            </div>
                                        `;
                                    } else {
                                        summary.innerHTML = '<div style="text-align: center; color: #10B981; padding: 10px;">✅ All caught up!</div>';
                                    }
                                }
                            })
                            .catch(err => {
                                console.error('Error loading pending adjustments:', err);
                                document.getElementById('pending-adjustments-summary').innerHTML = 
                                    '<div style="text-align: center; color: #8B949E; padding: 10px;">--</div>';
                            });
                    })();
                </script>  

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Admin Calendar Section - Hidden by default, shown only when server selected and calendar tab clicked -->
            <section class="content-section" id="section-admin-calendar">
                <div class="content-header">
                    <h1 class="content-title">Admin Calendar</h1>
                    <p class="content-subtitle">View and edit employee time entries</p>
                </div>

                <div class="tiles-grid">
                    <div class="tile" style="grid-column: 1 / -1;">
                        <!-- Mode Toggle -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <button id="btn-view-as-mode" class="tool-btn" onclick="setAdminCalendarMode('viewAs')" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                                👤 View As Employee
                            </button>
                            <button id="btn-master-mode" class="tool-btn" onclick="setAdminCalendarMode('master')" style="background: rgba(75, 85, 99, 0.5);">
                                📅 Master Calendar
                            </button>
                        </div>

                        <!-- View As Employee Mode -->
                        <div id="admin-calendar-viewas" style="display: block;">
                            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; color: #8B949E; font-size: 12px; margin-bottom: 6px;">Select Employee</label>
                                    <select id="admin-calendar-employee-select" onchange="loadEmployeeCalendar()" style="background: #161B22; border: 1px solid #30363D; color: #C9D1D9; padding: 10px 12px; border-radius: 8px; min-width: 220px; font-size: 14px;">
                                        <option value="">-- Select an employee --</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 18px;">
                                    <button id="emp-calendar-prev" class="calendar-nav-btn" onclick="navigateEmployeeCalendar(-1)">← Prev</button>
                                    <span id="emp-calendar-month-label" style="color: #D4AF37; font-weight: 600; min-width: 130px; text-align: center;">--</span>
                                    <button id="emp-calendar-next" class="calendar-nav-btn" onclick="navigateEmployeeCalendar(1)">Next →</button>
                                </div>
                            </div>
                            <div id="admin-employee-calendar-container">
                                <div id="emp-calendar-grid" class="calendar-grid">
                                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #8B949E;">
                                        Select an employee above to view their calendar
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Master Calendar Mode -->
                        <div id="admin-calendar-master" style="display: none;">
                            <!-- Month Navigation -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                <button onclick="navigateMasterCalendar(-1)" class="calendar-nav-btn">← Prev</button>
                                <span id="master-calendar-month-label" style="color: #D4AF37; font-size: 18px; font-weight: 600;"></span>
                                <button onclick="navigateMasterCalendar(1)" class="calendar-nav-btn">Next →</button>
                            </div>
                            <div id="master-calendar-grid" class="calendar-grid">
                                <!-- Calendar days will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Edit Modal -->
                <div id="session-edit-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: #161B22; border: 1px solid #30363D; border-radius: 12px; padding: 24px; max-width: 450px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #C9D1D9; margin: 0;">Edit Session</h3>
                            <button onclick="closeSessionEditModal()" style="background: none; border: none; color: #8B949E; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div id="session-edit-content">
                            <!-- Form content injected by JS -->
                        </div>
                    </div>
                </div>

                <script>
                    let adminCalendarMode = 'viewAs';
                    let masterCalendarYear = new Date().getFullYear();
                    let masterCalendarMonth = new Date().getMonth() + 1;
                    let masterCalendarData = null;
                    
                    // Helper to escape HTML for safe rendering
                    function escapeHtml(text) {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }

                    function setAdminCalendarMode(mode) {
                        adminCalendarMode = mode;
                        document.getElementById('btn-view-as-mode').style.background = mode === 'viewAs' ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'rgba(75, 85, 99, 0.5)';
                        document.getElementById('btn-master-mode').style.background = mode === 'master' ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'rgba(75, 85, 99, 0.5)';
                        document.getElementById('admin-calendar-viewas').style.display = mode === 'viewAs' ? 'block' : 'none';
                        document.getElementById('admin-calendar-master').style.display = mode === 'master' ? 'block' : 'none';
                        
                        if (mode === 'viewAs') {
                            loadEmployeeListForCalendar();
                        } else {
                            loadMasterCalendar();
                        }
                    }

                    async function loadEmployeeListForCalendar() {
                        const guildId = window.selectedGuildId;
                        if (!guildId) return;
                        
                        try {
                            const response = await fetch(`/api/guild/${guildId}/employees/calendar-list`, { credentials: 'include' });
                            const data = await response.json();
                            
                            const select = document.getElementById('admin-calendar-employee-select');
                            select.innerHTML = '<option value="">-- Select an employee --</option>';
                            
                            if (data.success && data.employees) {
                                data.employees.forEach(emp => {
                                    const option = document.createElement('option');
                                    option.value = emp.user_id;
                                    option.textContent = emp.display_name || emp.full_name || emp.user_id;
                                    select.appendChild(option);
                                });
                            }
                        } catch (error) {
                            console.error('Error loading employee list:', error);
                        }
                    }

                    let empCalendarYear = new Date().getFullYear();
                    let empCalendarMonth = new Date().getMonth() + 1;
                    let empCalendarData = null;
                    let currentEmpCalendarEmployeeId = null;

                    async function loadEmployeeCalendar() {
                        const guildId = window.selectedGuildId;
                        const employeeId = document.getElementById('admin-calendar-employee-select').value;
                        const grid = document.getElementById('emp-calendar-grid');
                        const monthLabel = document.getElementById('emp-calendar-month-label');
                        
                        currentEmpCalendarEmployeeId = employeeId;
                        
                        if (!employeeId) {
                            monthLabel.textContent = '--';
                            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8B949E; padding: 40px;">Select an employee above to view their calendar</div>';
                            return;
                        }
                        
                        monthLabel.textContent = new Date(empCalendarYear, empCalendarMonth - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8B949E; padding: 40px;">Loading calendar...</div>';
                        
                        try {
                            const response = await fetch(`/api/guild/${guildId}/employee/${employeeId}/monthly-timecard?year=${empCalendarYear}&month=${empCalendarMonth}`, { credentials: 'include' });
                            const data = await response.json();
                            
                            if (data.success) {
                                empCalendarData = data.data;
                                renderEmployeeCalendar();
                            } else {
                                grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; color: #EF4444; padding: 40px;">Error: ${data.error}</div>`;
                            }
                        } catch (error) {
                            console.error('Error loading employee calendar:', error);
                            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #EF4444; padding: 40px;">Failed to load calendar</div>';
                        }
                    }

                    function navigateEmployeeCalendar(delta) {
                        empCalendarMonth += delta;
                        if (empCalendarMonth > 12) {
                            empCalendarMonth = 1;
                            empCalendarYear++;
                        } else if (empCalendarMonth < 1) {
                            empCalendarMonth = 12;
                            empCalendarYear--;
                        }
                        loadEmployeeCalendar();
                    }

                    function renderEmployeeCalendar() {
                        const grid = document.getElementById('emp-calendar-grid');
                        const daysInMonth = new Date(empCalendarYear, empCalendarMonth, 0).getDate();
                        const firstDayOfWeek = new Date(empCalendarYear, empCalendarMonth - 1, 1).getDay();
                        
                        // Build days lookup
                        const daysLookup = {};
                        if (empCalendarData && empCalendarData.days) {
                            empCalendarData.days.forEach(d => {
                                daysLookup[d.date] = d;
                            });
                        }
                        
                        // Header row
                        let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => 
                            `<div class="calendar-day-header">${d}</div>`
                        ).join('');
                        
                        // Empty cells for first week
                        for (let i = 0; i < firstDayOfWeek; i++) {
                            html += '<div class="calendar-day empty"></div>';
                        }
                        
                        // Day cells
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateStr = `${empCalendarYear}-${String(empCalendarMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayData = daysLookup[dateStr];
                            const hasData = dayData && dayData.sessions && dayData.sessions.length > 0;
                            const totalHours = hasData ? dayData.total_seconds / 3600 : 0;
                            
                            let dayClass = 'calendar-day';
                            if (hasData) {
                                dayClass += ' has-sessions';
                                if (totalHours >= 7) dayClass += ' full-day';
                                else if (totalHours >= 4) dayClass += ' half-day';
                                else dayClass += ' partial-day';
                            }
                            
                            html += `
                                <div class="${dayClass}" ${hasData ? `onclick="showEmpDayDetail('${dateStr}')"` : ''}>
                                    <div class="day-number">${day}</div>
                                    ${hasData ? `
                                        <div class="day-hours">${totalHours.toFixed(1)}h</div>
                                        <div class="day-sessions">${dayData.sessions.length} session${dayData.sessions.length > 1 ? 's' : ''}</div>
                                    ` : '<div class="day-no-work">-</div>'}
                                </div>
                            `;
                        }
                        
                        grid.innerHTML = html;
                    }

                    function showEmpDayDetail(dateStr) {
                        if (!empCalendarData || !empCalendarData.days) return;
                        
                        const dayData = empCalendarData.days.find(d => d.date === dateStr);
                        if (!dayData || !dayData.sessions) return;
                        
                        const modal = document.getElementById('session-edit-modal');
                        const content = document.getElementById('session-edit-content');
                        
                        const totalHours = (dayData.total_seconds / 3600).toFixed(2);
                        let html = `
                            <h4 style="color: #C9D1D9; margin-bottom: 10px;">${new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</h4>
                            <div style="color: #10B981; font-size: 14px; margin-bottom: 15px;">${totalHours} hours total</div>
                        `;
                        
                        dayData.sessions.forEach(s => {
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(16, 24, 39, 0.5); padding: 10px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">
                                    <span style="color: #8B949E;">
                                        ${new Date(s.clock_in).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                        ${s.clock_out ? ' - ' + new Date(s.clock_out).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : ' - Active'}
                                    </span>
                                    <button onclick="openSessionEditModal(${s.id}, '${s.clock_in}', '${s.clock_out || ''}')" 
                                            style="background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #FCD34D; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                        Edit
                                    </button>
                                </div>
                            `;
                        });
                        
                        content.innerHTML = html;
                        modal.style.display = 'flex';
                    }

                    async function loadMasterCalendar() {
                        const guildId = window.selectedGuildId;
                        if (!guildId) return;
                        
                        document.getElementById('master-calendar-month-label').textContent = new Date(masterCalendarYear, masterCalendarMonth - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        
                        const grid = document.getElementById('master-calendar-grid');
                        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8B949E; padding: 40px;">Loading...</div>';
                        
                        try {
                            const response = await fetch(`/api/guild/${guildId}/admin/master-calendar?year=${masterCalendarYear}&month=${masterCalendarMonth}`, { credentials: 'include' });
                            const data = await response.json();
                            
                            if (data.success) {
                                masterCalendarData = data.data;
                                renderMasterCalendar();
                            } else {
                                grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; color: #EF4444; padding: 40px;">${data.error}</div>`;
                            }
                        } catch (error) {
                            console.error('Error loading master calendar:', error);
                            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #EF4444; padding: 40px;">Failed to load calendar</div>';
                        }
                    }

                    function renderMasterCalendar() {
                        const grid = document.getElementById('master-calendar-grid');
                        const daysInMonth = new Date(masterCalendarYear, masterCalendarMonth, 0).getDate();
                        const firstDayOfWeek = new Date(masterCalendarYear, masterCalendarMonth - 1, 1).getDay();
                        
                        // Build days lookup
                        const daysLookup = {};
                        if (masterCalendarData && masterCalendarData.days) {
                            masterCalendarData.days.forEach(d => {
                                daysLookup[d.date] = d;
                            });
                        }
                        
                        // Header row
                        let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => 
                            `<div class="calendar-day-header">${d}</div>`
                        ).join('');
                        
                        // Empty cells for first week
                        for (let i = 0; i < firstDayOfWeek; i++) {
                            html += '<div class="calendar-day empty"></div>';
                        }
                        
                        // Day cells
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateStr = `${masterCalendarYear}-${String(masterCalendarMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayData = daysLookup[dateStr];
                            const hasData = dayData && dayData.employee_count > 0;
                            const totalHours = hasData ? dayData.total_hours : 0;
                            
                            let dayClass = 'calendar-day';
                            if (hasData) {
                                dayClass += ' has-sessions';
                                if (totalHours >= 16) dayClass += ' full-day';
                                else if (totalHours >= 8) dayClass += ' half-day';
                                else dayClass += ' partial-day';
                            }
                            
                            html += `
                                <div class="${dayClass}" ${hasData ? `onclick="showDayDetail('${dateStr}')"` : ''}>
                                    <div class="day-number">${day}</div>
                                    ${hasData ? `
                                        <div class="day-hours">${totalHours.toFixed(1)}h</div>
                                        <div class="day-sessions">${dayData.employee_count} employee${dayData.employee_count > 1 ? 's' : ''}</div>
                                    ` : '<div class="day-no-work">-</div>'}
                                </div>
                            `;
                        }
                        
                        grid.innerHTML = html;
                    }

                    function navigateMasterCalendar(delta) {
                        masterCalendarMonth += delta;
                        if (masterCalendarMonth > 12) {
                            masterCalendarMonth = 1;
                            masterCalendarYear++;
                        } else if (masterCalendarMonth < 1) {
                            masterCalendarMonth = 12;
                            masterCalendarYear--;
                        }
                        loadMasterCalendar();
                    }

                    function showDayDetail(dateStr) {
                        if (!masterCalendarData || !masterCalendarData.days) return;
                        
                        const dayData = masterCalendarData.days.find(d => d.date === dateStr);
                        if (!dayData) return;
                        
                        const modal = document.getElementById('session-edit-modal');
                        const content = document.getElementById('session-edit-content');
                        
                        let html = `<h4 style="color: #C9D1D9; margin-bottom: 15px;">${new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</h4>`;
                        
                        dayData.employees.forEach(emp => {
                            html += `
                                <div style="background: rgba(30, 40, 60, 0.6); border: 1px solid #30363D; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                    <div style="color: #C9D1D9; font-weight: 600; margin-bottom: 8px;">${escapeHtml(emp.name)}</div>
                                    <div style="color: #10B981; font-size: 13px; margin-bottom: 8px;">${(emp.total_seconds / 3600).toFixed(2)} hours total</div>
                                    ${emp.sessions.map(s => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(16, 24, 39, 0.5); padding: 8px 10px; border-radius: 6px; font-size: 13px; margin-bottom: 6px;">
                                            <span style="color: #8B949E;">
                                                ${new Date(s.clock_in).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                                                ${s.clock_out ? ' - ' + new Date(s.clock_out).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : ' - Active'}
                                            </span>
                                            <button onclick="openSessionEditModal(${s.id}, '${s.clock_in}', '${s.clock_out || ''}')" 
                                                    style="background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #FCD34D; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                Edit
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        });
                        
                        content.innerHTML = html;
                        modal.style.display = 'flex';
                    }

                    function openSessionEditModal(sessionId, clockIn, clockOut) {
                        const modal = document.getElementById('session-edit-modal');
                        const content = document.getElementById('session-edit-content');
                        
                        const clockInDate = clockIn ? new Date(clockIn) : null;
                        const clockOutDate = clockOut ? new Date(clockOut) : null;
                        
                        content.innerHTML = `
                            <form id="session-edit-form" onsubmit="saveSessionEdit(event, ${sessionId})">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; color: #8B949E; font-size: 12px; margin-bottom: 6px;">Clock In</label>
                                    <input type="datetime-local" id="edit-clock-in" value="${clockInDate ? clockInDate.toISOString().slice(0, 16) : ''}" 
                                           style="background: #0D1117; border: 1px solid #30363D; color: #C9D1D9; padding: 10px; border-radius: 6px; width: 100%;">
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; color: #8B949E; font-size: 12px; margin-bottom: 6px;">Clock Out</label>
                                    <input type="datetime-local" id="edit-clock-out" value="${clockOutDate ? clockOutDate.toISOString().slice(0, 16) : ''}" 
                                           style="background: #0D1117; border: 1px solid #30363D; color: #C9D1D9; padding: 10px; border-radius: 6px; width: 100%;">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; color: #8B949E; font-size: 12px; margin-bottom: 6px;">Reason for Edit</label>
                                    <input type="text" id="edit-reason" placeholder="e.g., Forgot to clock out" 
                                           style="background: #0D1117; border: 1px solid #30363D; color: #C9D1D9; padding: 10px; border-radius: 6px; width: 100%;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button type="submit" style="flex: 1; background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        Save Changes
                                    </button>
                                    <button type="button" onclick="closeSessionEditModal()" style="background: rgba(75, 85, 99, 0.5); border: none; color: #C9D1D9; padding: 12px 20px; border-radius: 8px; cursor: pointer;">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        `;
                        
                        modal.style.display = 'flex';
                    }

                    function closeSessionEditModal() {
                        document.getElementById('session-edit-modal').style.display = 'none';
                    }

                    async function saveSessionEdit(event, sessionId) {
                        event.preventDefault();
                        
                        const guildId = window.selectedGuildId;
                        const clockIn = document.getElementById('edit-clock-in').value;
                        const clockOut = document.getElementById('edit-clock-out').value;
                        const reason = document.getElementById('edit-reason').value;
                        
                        try {
                            const response = await fetch(`/api/guild/${guildId}/admin/edit-session`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({
                                    session_id: sessionId,
                                    clock_in: clockIn ? new Date(clockIn).toISOString() : null,
                                    clock_out: clockOut ? new Date(clockOut).toISOString() : null,
                                    reason: reason || 'Admin adjustment'
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                closeSessionEditModal();
                                // Refresh the current view
                                if (adminCalendarMode === 'viewAs') {
                                    loadEmployeeCalendar();
                                } else {
                                    loadMasterCalendar();
                                }
                            } else {
                                alert('Error: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error saving session edit:', error);
                            alert('Failed to save changes');
                        }
                    }

                    // Initialize when section becomes visible
                    document.addEventListener('DOMContentLoaded', function() {
                        const observer = new MutationObserver(function(mutations) {
                            mutations.forEach(function(mutation) {
                                if (mutation.target.id === 'section-admin-calendar' && 
                                    !mutation.target.classList.contains('hidden') &&
                                    mutation.target.style.display !== 'none') {
                                    loadEmployeeListForCalendar();
                                }
                            });
                        });
                        
                        const section = document.getElementById('section-admin-calendar');
                        if (section) {
                            observer.observe(section, { attributes: true, attributeFilter: ['class', 'style'] });
                        }
                    });
                </script>
            </section>

            <!-- Ban Management Section -->
            <section class="content-section" id="section-ban-management">
                <div class="content-header">
                    <h1 class="content-title">Ban Management</h1>
                    <p class="content-subtitle">Manage banned users and spam/abuse infractions</p>
                </div>

                <div class="tiles-grid">
                    <div class="tile">
                        <h2><span class="tile-icon">🚫</span>Ban Management</h2>
                        <p class="tile-description">Manage banned users and spam/abuse infractions. Monitor user
                            warnings and control access.</p>

                        <!-- Important Warning -->
                        <div
                            style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid #EF4444; padding: 12px; margin: 15px 0; border-radius: 6px;">
                            <div style="display: flex; align-items: start; gap: 10px;">
                                <span style="font-size: 18px; flex-shrink: 0;">⚠️</span>
                                <div style="font-size: 12px; color: #FCA5A5; line-height: 1.6;">
                                    <strong style="display: block; margin-bottom: 4px;">Important Reminder:</strong>
                                    Excessive spam or abuse may result in the bot being removed from Discord. Use
                                    permanent bans carefully and ensure your server moderators use usage appropriately.
                                </div>
                            </div>
                        </div>

                        <!-- Banned Users Table -->
                        <div id="banned-users-container" style="margin-top: 20px;">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-weight: 500; color: #C9D1D9; font-size: 14px;">Banned Users</span>
                                <button onclick="loadBannedUsers()"
                                    style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #60A5FA; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    🔄 Refresh
                                </button>
                            </div>
                            <div id="banned-users-list"
                                style="background: rgba(16, 24, 39, 0.6); border: 1px solid rgba(75, 85, 99, 0.4); border-radius: 8px; padding: 12px; min-height: 100px;">
                                <div style="text-align: center; color: #8B949E; padding: 20px;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">🔄</div>
                                    <div>Loading banned users...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Beta Settings Section -->
            <section class="content-section" id="section-beta-settings">
                <div class="content-header">
                    <h1 class="content-title">Beta Settings</h1>
                    <p class="content-subtitle">Experimental features - may have limitations</p>
                </div>

                <!-- Beta Features Notice Banner -->
                <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.15)); border: 2px solid rgba(245, 158, 11, 0.4); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: start; gap: 15px;">
                        <span style="font-size: 28px; flex-shrink: 0;">⚠️</span>
                        <div>
                            <strong style="font-size: 16px; color: #FCD34D; display: block; margin-bottom: 8px;">Beta Features Notice</strong>
                            <p style="font-size: 14px; color: #FDE68A; line-height: 1.6; margin: 0;">
                                These settings are experimental and may not work consistently in all scenarios. 
                                Please report any issues and use with caution.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Admin Beta Settings Section -->
                <div class="beta-admin-section admin-only">
                    <h3 style="color: #D4AF37; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>👑</span> Admin Beta Settings
                    </h3>
                    <div class="tiles-grid">
                        <!-- Mobile Device Restriction Tile -->
                        <div class="tile">
                            <h2><span class="tile-icon">📱</span>Mobile Device Restrictions</h2>
                            <p class="tile-description">Control whether employees can clock in/out from mobile or tablet
                                devices.</p>

                            <!-- Warning Notice -->
                            <div
                                style="background: rgba(245, 158, 11, 0.1); border-left: 3px solid #F59E0B; padding: 12px; margin: 15px 0; border-radius: 6px;">
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <span style="font-size: 18px; flex-shrink: 0;">⚠️</span>
                                    <div style="font-size: 12px; color: #FCD34D; line-height: 1.6;">
                                        <strong style="display: block; margin-bottom: 6px;">Device Detection
                                            Limitations:</strong>
                                        <ul style="margin: 0; padding-left: 18px;">
                                            <li>Discord doesn't distinguish between phones and tablets (both appear as
                                                "mobile")</li>
                                            <li>Users on multiple devices simultaneously (e.g., desktop + phone) may bypass
                                                this restriction</li>
                                            <li>Users set to invisible/offline cannot be detected</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Toggle -->
                            <div class="setting-row" style="margin-top: 20px;">
                                <div class="setting-label">
                                    <span style="font-weight: 500; color: #C9D1D9;">Restrict Mobile/Tablet Clock-ins</span>
                                    <span class="setting-description"
                                        style="display: block; margin-top: 4px; font-size: 12px; color: #8B949E;">
                                        When enabled, employees must use desktop or web browser to clock in/out
                                    </span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="restrict-mobile-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employee Beta Settings Section -->
                <div class="beta-employee-section" style="margin-top: 30px;">
                    <h3 style="color: #D4AF37; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>👷</span> Employee Beta Settings
                    </h3>
                    <div class="tiles-grid">
                        <div class="tile">
                            <div style="text-align: center; padding: 30px 20px; color: #8B949E;">
                                <div style="font-size: 48px; margin-bottom: 15px;">🔜</div>
                                <p style="font-size: 14px; margin: 0;">No employee beta features available yet. Check back soon!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Admin Roles Section -->
            <section class="content-section" id="section-admin-roles">
                <div class="content-header">
                    <h1 class="content-title">Admin Roles</h1>
                    <p class="content-subtitle">Manage roles that can access admin features</p>
                </div>

                <!-- Sync Notice -->
                <div class="sync-notice">
                    <div class="sync-notice-icon">⏳</div>
                    <div class="sync-notice-text">
                        <strong>Sync Notice:</strong> Changes may take up to 10 seconds to sync with Discord commands.
                        Refresh this page to see the latest updates.
                    </div>
                </div>

                <div class="tiles-grid">
                    <div class="tile">
                        <h2><span class="tile-icon">👥</span>Admin Roles</h2>
                        <p class="tile-description">Set which roles can access admin features like Reports and Upgrade
                            buttons. Discord administrators always have access.</p>

                        <div class="dual-listbox-container">
                            <div class="listbox-wrapper">
                                <div class="listbox-label">Available Roles</div>
                                <div class="listbox" id="available-admin-roles"></div>
                            </div>
                            <div class="transfer-buttons">
                                <button class="transfer-btn" id="add-admin-role-btn" disabled>→</button>
                                <button class="transfer-btn" id="remove-admin-role-btn" disabled>←</button>
                            </div>
                            <div class="listbox-wrapper">
                                <div class="listbox-label">Admin Roles</div>
                                <div class="listbox" id="current-admin-roles"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Employee Roles Section -->
            <section class="content-section" id="section-employee-roles">
                <div class="content-header">
                    <h1 class="content-title">Employee Roles</h1>
                    <p class="content-subtitle">Manage roles that can use timeclock functions</p>
                </div>

                <!-- Sync Notice -->
                <div class="sync-notice">
                    <div class="sync-notice-icon">⏳</div>
                    <div class="sync-notice-text">
                        <strong>Sync Notice:</strong> Changes may take up to 10 seconds to sync with Discord commands.
                        Refresh this page to see the latest updates.
                    </div>
                </div>

                <div class="tiles-grid">
                    <div class="tile">
                        <h2><span class="tile-icon">👷</span>Employee Roles</h2>
                        <p class="tile-description">Choose which roles can use the /clock command and access timeclock
                            functions.</p>

                        <div class="dual-listbox-container">
                            <div class="listbox-wrapper">
                                <div class="listbox-label">Available Roles</div>
                                <div class="listbox" id="available-roles"></div>
                            </div>
                            <div class="transfer-buttons">
                                <button class="transfer-btn" id="add-role-btn" disabled>→</button>
                                <button class="transfer-btn" id="remove-role-btn" disabled>←</button>
                            </div>
                            <div class="listbox-wrapper">
                                <div class="listbox-label">Employee Roles</div>
                                <div class="listbox" id="current-roles"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Email Settings Section -->
            <section class="content-section" id="section-email-settings">
                <div class="content-header">
                    <h1 class="content-title">Email Settings</h1>
                    <p class="content-subtitle">Configure email recipients for reports and delivery method</p>
                </div>

                <div class="tiles-grid">
                    <!-- Email Recipients Tile -->
                    <div class="tile">
                        <h2><span class="tile-icon">📧</span>Email Recipients</h2>
                        <p class="tile-description" style="color: #8B949E; font-size: 13px; margin-bottom: 15px;">Manage
                            email addresses that will receive automated reports</p>

                        <div class="email-input-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="email" class="email-input" id="email-input" placeholder="Enter email address"
                                style="flex: 1; background: rgba(10, 15, 31, 0.5); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 8px; padding: 12px; color: #C9D1D9; font-size: 14px;">
                            <button class="btn" id="add-email-btn"
                                style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; white-space: nowrap;">Add
                                Email</button>
                        </div>

                        <div class="email-list" id="email-list"
                            style="background: rgba(10, 15, 31, 0.5); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 8px; max-height: 200px; overflow-y: auto; padding: 10px;">
                            <div class="empty-state"
                                style="text-align: center; padding: 40px 20px; color: #8B949E; font-size: 13px;">No
                                email addresses configured</div>
                        </div>

                        <div style="margin-top: 15px;">
                            <button id="test-email-btn" class="btn"
                                style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;">
                                <span>📬</span>
                                <span>Send Test Email</span>
                            </button>
                            <p style="margin-top: 8px; color: #8B949E; font-size: 12px;">
                                Verify your email setup is working by sending a test message to all configured recipients
                            </p>
                        </div>

                        <div class="workday-time-setting"
                            style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                            <label style="display: block; color: #C9D1D9; font-weight: 500; margin-bottom: 10px;">
                                🕰️ Work Day End Time (for auto-send reports)
                            </label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="time" id="work-day-end-time" value="17:00"
                                    style="background: rgba(30, 35, 45, 0.8); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 6px; padding: 8px 12px; color: #C9D1D9; font-size: 14px; flex: 0 0 auto;">
                                <button id="save-workday-time-btn" class="btn"
                                    style="background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;">
                                    Save Time
                                </button>
                            </div>
                            <p style="margin-top: 8px; color: #8B949E; font-size: 12px;">
                                Reports will be auto-sent at this time if toggle is enabled
                            </p>
                        </div>

                        <!-- Fail-safe guidance - shown when no email recipients configured -->
                        <div id="email-settings-guidance"
                            style="margin-top: 15px; padding: 15px; background: rgba(245, 158, 11, 0.15); border: 2px solid rgba(245, 158, 11, 0.5); border-radius: 8px; display: block;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">⚠️</span>
                                <span style="color: #F59E0B; font-weight: 600; font-size: 14px;">Email Recipients Required</span>
                            </div>
                            <p style="color: #C9D1D9; font-size: 13px; margin: 0;">
                                Add at least one email address above to enable email automation features. 
                                The toggles and work day end time settings below will be enabled once you add a recipient.
                            </p>
                        </div>

                        <div class="toggle-group"
                            style="background: rgba(10, 15, 31, 0.5); border: 1px solid rgba(212, 175, 55, 0.15); border-radius: 8px; padding: 15px; margin-top: 15px; display: flex; flex-direction: column; gap: 12px;">
                            <div class="toggle-item"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <span class="toggle-label" style="font-size: 14px; color: #C9D1D9;">📤 Auto-send
                                    report
                                    on clock-out</span>
                                <label class="toggle-switch" style="position: relative; width: 50px; height: 26px;">
                                    <input type="checkbox" id="toggle-auto-send-clockout"
                                        style="opacity: 0; width: 0; height: 0;" disabled>
                                    <span class="toggle-slider"
                                        style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(30, 35, 45, 0.5); transition: 0.4s; border-radius: 34px; border: 1px solid rgba(212, 175, 55, 0.2);"></span>
                                </label>
                            </div>
                            <div class="toggle-item"
                                style="display: flex; align-items: center; justify-content: space-between;">
                                <span class="toggle-label" style="font-size: 14px; color: #C9D1D9;">⏰ Auto-email
                                    before
                                    data deletion</span>
                                <label class="toggle-switch" style="position: relative; width: 50px; height: 26px;">
                                    <input type="checkbox" id="toggle-auto-email-delete"
                                        style="opacity: 0; width: 0; height: 0;" disabled>
                                    <span class="toggle-slider"
                                        style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(30, 35, 45, 0.5); transition: 0.4s; border-radius: 34px; border: 1px solid rgba(212, 175, 55, 0.2);"></span>
                                </label>
                            </div>
                        </div>

                        <div class="email-note"
                            style="margin-top: 15px; padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: #9CA3AF; font-size: 13px;">
                            ℹ️ <strong>Note:</strong> Email automation features require configured recipients. The system will automatically disable these settings if all email recipients are removed.
                        </div>
                    </div>

                    <!-- Custom Email Formatting Tile (COMING SOON) -->
                    <div class="tile" style="position: relative;">
                        <h2><span class="tile-icon">✉️</span>Custom Email Formatting</h2>
                        <p class="tile-description" style="color: #8B949E; font-size: 13px; margin-bottom: 15px;">
                            Customize the format and appearance of automated email reports</p>

                        <div class="coming-soon-overlay"
                            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(5px); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; gap: 20px;">
                            <div class="coming-soon-text"
                                style="font-size: 32px; font-weight: bold; color: #D4AF37; text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); letter-spacing: 3px;">
                                COMING SOON</div>
                            <p style="color: #9CA3AF; font-size: 14px; text-align: center; max-width: 300px;">
                                Advanced email customization features are being developed
                            </p>
                        </div>

                        <div style="padding: 20px; color: #8B949E;">
                            <p>Future features will include:</p>
                            <ul style="margin: 15px 0; padding-left: 20px;">
                                <li>Custom email templates</li>
                                <li>Branding and logo options</li>
                                <li>Report scheduling options</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Timezone Settings Section -->
            <section class="content-section" id="section-timezone-settings">
                <div class="content-header">
                    <h1 class="content-title">Timezone Settings</h1>
                    <p class="content-subtitle">Set the timezone for displaying time entries</p>
                </div>

                <!-- Sync Notice -->
                <div class="sync-notice">
                    <div class="sync-notice-icon">⏳</div>
                    <div class="sync-notice-text">
                        <strong>Sync Notice:</strong> Changes may take up to 10 seconds to sync with Discord commands.
                        Refresh this page to see the latest updates.
                    </div>
                </div>

                <div class="tiles-grid">
                    <div class="tile">
                        <h2><span class="tile-icon">&#9200;</span>Timezone Settings</h2>
                        <p class="tile-description">Set the timezone for displaying time entries in reports and notifications.</p>

                        <select id="timezone-select" class="timezone-select">
                            <option value="America/New_York">Eastern Time (US & Canada)</option>
                            <option value="America/Chicago">Central Time (US & Canada)</option>
                            <option value="America/Denver">Mountain Time (US & Canada)</option>
                            <option value="America/Phoenix">Arizona</option>
                            <option value="America/Los_Angeles">Pacific Time (US & Canada)</option>
                            <option value="America/Anchorage">Alaska</option>
                            <option value="Pacific/Honolulu">Hawaii</option>
                            <option value="Europe/London">London</option>
                            <option value="Europe/Paris">Paris</option>
                            <option value="Europe/Berlin">Berlin</option>
                            <option value="Asia/Tokyo">Tokyo</option>
                            <option value="Asia/Shanghai">Shanghai</option>
                            <option value="Asia/Dubai">Dubai</option>
                            <option value="Australia/Sydney">Sydney</option>
                        </select>

                        <button id="save-timezone-btn" class="save-btn">Save Timezone</button>
                    </div>
                    
                    <div class="tile">
                        <h2><span class="tile-icon">&#128227;</span>Announcement Channel</h2>
                        <p class="tile-description">Choose where the bot sends announcements and broadcasts. If not set, it will use the system channel or find the first available text channel.</p>

                        <select id="broadcast-channel-select" class="timezone-select">
                            <option value="">Use default (system channel)</option>
                        </select>

                        <button id="save-broadcast-channel-btn" class="save-btn">Save Channel</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Employee Status Section -->
            <section class="content-section" id="section-employees">
                <div class="content-header">
                    <h1 class="content-title">👥 Employee Status</h1>
                    <p class="content-subtitle">View active employees and their hours</p>
                </div>

                <!-- Inline Timezone Selector -->
                <div
                    style="display:flex; gap:12px; align-items:center; margin-bottom:20px; padding:12px 16px; background:rgba(139,148,158,0.1); border-radius:8px;">
                    <span style="color:#8B949E; font-size:13px;">Display times in:</span>
                    <select id="dashboard-timezone" class="timezone-select" style="flex:1; max-width:300px;">
                        <option value="America/New_York">Eastern Time (US & Canada)</option>
                        <option value="America/Chicago">Central Time (US & Canada)</option>
                        <option value="America/Denver">Mountain Time (US & Canada)</option>
                        <option value="America/Phoenix">Arizona</option>
                        <option value="America/Los_Angeles">Pacific Time (US & Canada)</option>
                        <option value="America/Anchorage">Alaska</option>
                        <option value="Pacific/Honolulu">Hawaii</option>
                        <option value="Europe/London">London</option>
                        <option value="Europe/Paris">Paris</option>
                        <option value="Europe/Berlin">Berlin</option>
                        <option value="Asia/Tokyo">Tokyo</option>
                        <option value="Asia/Shanghai">Shanghai</option>
                        <option value="Asia/Dubai">Dubai</option>
                        <option value="Australia/Sydney">Sydney</option>
                    </select>
                </div>

                <!-- Employee Cards Grid -->
                <div class="employee-cards-grid" id="employee-cards-container">
                    <!-- Dynamically populated -->
                    <div class="empty-state">Loading employees...</div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- On the Clock Section (Employee View) -->
            <section class="content-section" id="section-on-the-clock">
                <div class="content-header">
                    <h1 class="content-title">⏰ On the Clock</h1>
                    <p class="content-subtitle">See who's currently working</p>
                </div>
                
                <!-- Currently Clocked In Co-workers -->
                <div class="tile" style="margin-bottom: 24px;">
                    <h2><span class="tile-icon">👥</span> Co-workers Currently Working</h2>
                    <div id="coworkers-on-clock-container" class="coworkers-grid">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
                
                <!-- My Contact Info -->
                <div class="tile">
                    <h2><span class="tile-icon">📇</span> My Contact Card</h2>
                    <p style="color: #8B949E; font-size: 13px; margin-bottom: 16px;">This information is visible to your employer</p>
                    <div id="my-contact-form">
                        <div class="empty-state" style="color: #8B949E;">Contact card feature coming soon</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    
                    <a href="mailto:hypnotikotc@gmail.com?subject=On%20the%20Clock%20-%20App%20Ideas%20%26%20Requests"
                        class="btn support-button">
                        <span>✉️</span>
                        <span>App Ideas & Requests</span>
                    </a>
                </div>
            </section>

            <!-- Time Adjustments Section -->
            <section class="content-section" id="section-adjustments">
                <div class="content-header">
                    <h1 class="content-title">⏳ Time Adjustments</h1>
                    <p class="content-subtitle">Request changes or review pending adjustments</p>
                </div>


                <!-- Calendar View - adapts based on role -->
                <div class="tile" id="adjustments-calendar-container" style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <!-- For admin: "Pending Requests Calendar", for employee: "My Work Calendar" -->
                        <h2 id="calendar-title"><span class="tile-icon">&#128197;</span><span id="calendar-title-text">My Work Calendar</span></h2>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button id="calendar-prev-month" class="calendar-nav-btn" title="Previous Month">&larr; Prev</button>
                            <span id="calendar-month-year" style="color: #D4AF37; font-weight: 600; min-width: 150px; text-align: center;">Loading...</span>
                            <button id="calendar-next-month" class="calendar-nav-btn" title="Next Month">Next &rarr;</button>
                        </div>
                    </div>
                    
                    <!-- Employee: Active session alert with Clock Out button -->
                    <div id="active-session-alert" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(245, 158, 11, 0.15); border: 1px solid #F59E0B; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="color: #F59E0B; font-weight: 600;">&#9888; You are currently clocked in</span>
                                <div id="active-session-time" style="color: #8B949E; font-size: 13px; margin-top: 4px;">Since: --:--</div>
                            </div>
                            <button id="clock-out-now-btn" class="btn-warning" style="padding: 8px 16px; background: #F59E0B; color: #0A0F1F; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Clock Out Now</button>
                        </div>
                    </div>
                    
                    <div id="calendar-grid" class="calendar-grid">
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #8B949E;">Loading calendar...</div>
                    </div>
                    <div id="calendar-help-text" style="margin-top: 20px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 3px solid #D4AF37;">
                        <div style="font-size: 13px; color: #C9D1D9;"><strong>&#128161; How to use:</strong> <span id="calendar-help-content">Click on any day with work sessions to view details.</span></div>
                    </div>
                </div>

                <!-- Pending Requests Section (shown for both, but content differs) -->
                <div id="pending-requests-section" style="margin-top: 30px;">
                    <h2 style="color: #D4AF37; margin-bottom: 20px;">&#128276; <span id="pending-section-title">Pending Requests</span></h2>
                    <p id="pending-section-desc" style="color: #8B949E; font-size: 13px; margin-bottom: 15px;"></p>
                    <div id="pending-adjustments-list">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>

                <!-- Past Requests Section (collapsible) -->
                <div id="past-requests-section" style="margin-top: 30px;">
                    <div id="past-requests-header" style="cursor: pointer; display: flex; align-items: center; gap: 10px;" onclick="togglePastRequests()">
                        <span id="past-requests-toggle" style="transition: transform 0.2s;">&#9654;</span>
                        <h2 style="color: #8B949E; margin: 0;">&#128196; Past Requests <span id="past-requests-count" style="font-size: 14px; opacity: 0.7;">(0)</span></h2>
                    </div>
                    <div id="past-requests-content" style="display: none; margin-top: 15px;">
                        <div id="past-adjustments-list">
                            <div class="empty-state">No past requests</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Mobile hamburger button - always on top -->
    <div class="mobile-hamburger" id="mobileHamburger">
        <span class="hamburger-icon">☰</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Employee Detail Modal -->
        <div id="employee-detail-overlay" class="employee-detail-overlay" style="display: none;">
            <div class="employee-detail-modal manila-folder">
                <div class="folder-tab">EMPLOYEE FILE</div>
                <button class="modal-close-btn" onclick="closeEmployeeDetailView()">✕</button>

                <div class="employee-detail-header">
                    <div class="employee-avatar-large" id="detail-avatar">&#63;</div>
                    <div class="employee-info">
                        <h2 id="detail-name">Loading...</h2>
                        <div id="detail-status">Status: Loading...</div>
                    </div>
                </div>

                <div class="employee-detail-content">
                    <!-- Weekly Timecard -->
                    <section class="detail-section">
                        <h3>📅 Weekly Timecard</h3>
                        <div id="weekly-timecard-grid" class="timecard-grid">
                            <!-- Populated by JS -->
                        </div>
                    </section>

                    <!-- Recent Requests -->
                    <section class="detail-section">
                        <h3>📝 Recent Adjustment Requests</h3>
                        <div id="recent-requests-list">
                            <!-- Populated by JS -->
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- Matrix Animation Script -->
        <script src="/static/js/dashboard-matrix.js"></script>
        <!-- Dashboard Roles -->
        <script src="/static/js/dashboard-roles.js"></script>

        <!-- Dashboard Core Logic -->
        <script src="/static/js/dashboard-core.js"></script>
        <!-- Dashboard Adjustments Calendar -->
        <script src="/static/js/dashboard-adjustments.js"></script>

        <!-- Calendar Initialization -->
        <script>
            // Initialize calendar when adjustments section is active
            const currentGuildId = document.getElementById('guild-selector')?.value;
            const currentUserId = '{{ user.user_id }}';
            
            if (currentGuildId && currentUserId) {
                // Wait for calendar script to load, then initialize
                setTimeout(() => {
                    if (typeof initializeAdjustmentsCalendar === 'function') {
                        initializeAdjustmentsCalendar(currentGuildId, currentUserId);
                    }
                }, 500);
            }
        </script>

    <!-- Sidebar Toggle Script (mobile/tablet support) -->
    <script>
        (function() {
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const mobileHamburger = document.getElementById('mobileHamburger');
            
            function isMobile() {
                return window.innerWidth <= 1024;
            }
            
            function openSidebar() {
                document.body.classList.add('sidebar-open');
                sidebar.classList.remove('mobile-hidden');
                document.body.style.overflow = 'hidden';
            }
            
            function closeSidebar() {
                document.body.classList.remove('sidebar-open');
                sidebar.classList.add('mobile-hidden');
                document.body.style.overflow = '';
            }
            
            function initSidebarState() {
                document.body.classList.remove('sidebar-open');
                document.body.style.overflow = '';
                if (isMobile()) {
                    sidebar.classList.add('mobile-hidden');
                } else {
                    sidebar.classList.remove('mobile-hidden');
                }
            }
            
            initSidebarState();
            
            if (mobileHamburger) {
                mobileHamburger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (sidebar.classList.contains('mobile-hidden')) {
                        openSidebar();
                    } else {
                        closeSidebar();
                    }
                });
            }

            if (mobileOverlay) {
                mobileOverlay.addEventListener('click', function() {
                    closeSidebar();
                });
            }

            const navLinks = sidebar.querySelectorAll('.nav-item, .back-to-servers');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (isMobile()) {
                        closeSidebar();
                    }
                });
            });
            
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    document.body.classList.remove('sidebar-open');
                    document.body.style.overflow = '';
                    if (!isMobile()) {
                        sidebar.classList.remove('mobile-hidden');
                    } else {
                        sidebar.classList.add('mobile-hidden');
                    }
                }, 100);
            });
        })();
    </script>
</body>

</html>